<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Eden Perfume Sales Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Eden Perfume Sales Tracking System - Mobile & Desktop Optimized">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Eden Sales">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå∏</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{'name':'Eden Perfume Sales Tracker','short_name':'Eden Sales','description':'Complete sales tracking system for Eden Perfume','start_url':'./','display':'standalone','background_color':'#ffffff','theme_color':'#667eea','orientation':'portrait-primary','icons':[{'src':'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"40\" fill=\"%23667eea\"/><text x=\"50\" y=\"65\" text-anchor=\"middle\" fill=\"white\" font-size=\"30\">E</text></svg>','sizes':'192x192','type':'image/svg+xml'}]}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Your Firebase configuration
        // ‚ö†Ô∏è SECURITY NOTE: In production, use environment variables and restrict API key usage
        const firebaseConfig = {
            apiKey: "AIzaSyCdp7_OmJ0ZuHOZEviAb3vYUDHGmfU0AzM", // Restrict this key to your domain only
            authDomain: "eden-sales-2025.firebaseapp.com",
            projectId: "eden-sales-2025",
            storageBucket: "eden-sales-2025.firebasestorage.app",
            messagingSenderId: "307931071050",
            appId: "1:307931071050:web:97a021ab64546cb6c59cb3",
            measurementId: "G-BQ1BGN1NVZ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy };
    </script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .modal {
            backdrop-filter: blur(5px);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Enhanced Mobile & Desktop Responsive Design */
        body {
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Mobile First Approach */
        @media (max-width: 768px) {
            body { font-size: 13px; }
            .mobile-table { font-size: 11px; }
            .mobile-table td, .mobile-table th { padding: 6px 3px; }
            .mobile-btn { padding: 4px 6px; font-size: 10px; }
            .mobile-scroll { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            .mobile-grid { grid-template-columns: 1fr; gap: 8px; }
            .mobile-text { font-size: 12px; }
            .mobile-padding { padding: 12px; }
            .mobile-margin { margin: 8px; }
            
            /* Hide desktop-only elements on mobile */
            .desktop-only { display: none !important; }
            
            /* Mobile-specific layouts */
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100% !important; }
            .mobile-center { text-align: center; }
            
            /* Touch-friendly buttons */
            button, select, input { min-height: 44px; }
            .tab-button { padding: 12px 8px; font-size: 11px; }
        }
        
        /* Tablet View */
        @media (min-width: 769px) and (max-width: 1024px) {
            body { font-size: 14px; }
            .tablet-grid { grid-template-columns: repeat(2, 1fr); }
            .tablet-padding { padding: 16px; }
        }
        
        /* Desktop View */
        @media (min-width: 1025px) {
            body { font-size: 15px; }
            .desktop-grid { grid-template-columns: repeat(4, 1fr); }
            .desktop-padding { padding: 24px; }
            
            /* Hide mobile-only elements on desktop */
            .mobile-only { display: none !important; }
            
            /* Desktop-specific enhancements */
            .hover-effects:hover { transform: translateY(-2px); transition: all 0.3s ease; }
            .desktop-shadow { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12px; color: black; background: white; }
            .print-break { page-break-after: always; }
        }
        
        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            body { -webkit-font-smoothing: antialiased; }
        }
        
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
        }
        
        @media (prefers-color-scheme: dark) {
            .dark-mode-support { 
                background-color: #1a1a1a; 
                color: #ffffff; 
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">


    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-700">Loading data from Firebase...</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-3">
        <div class="bg-white rounded-2xl card-shadow p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">üå∏ Eden Perfume</h1>
                <p class="text-gray-600 text-sm">Sales Tracking System</p>
                <div class="mt-2 text-xs text-blue-600">üî• Firebase Connected</div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="employeeId" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-base" placeholder="Enter Username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-base" placeholder="Enter password">
                </div>
                
                <button onclick="login()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                    Login to System
                </button>
                
                <div class="text-center text-xs text-gray-500 mt-4 space-y-1">
                    <p><strong>Admin:</strong> eden | eden@123</p>
                    <p><strong>Staff:</strong> Add staff via admin panel</p>
                    <p><strong>Note:</strong> Fresh database - no sample data</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Dashboard -->
    <div id="employeePage" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold">üå∏ Eden Perfume</h1>
                    <p id="currentDate" class="text-purple-100 text-xs"></p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-purple-100">Welcome, <span id="employeeName"></span></p>
                    <div class="flex items-center space-x-1 mt-1">
                        <button onclick="manualSync()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs" title="Sync data">üîÑ</button>
                        <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-xs">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3">
            <!-- Sales Entry Form -->
            <div class="bg-white rounded-xl card-shadow p-4 mb-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4">üìù Add New Sale</h2>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="saleDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Name</label>
                        <select id="storeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                            <option value="">Select Store</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <select id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                            <input type="number" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base" placeholder="Qty" min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price (Optional)</label>
                            <input type="number" id="price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base" placeholder="Price" step="0.01">
                        </div>
                    </div>
                </div>
                
                <button onclick="addSale()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 mt-4">
                    üíæ Save Sale Data
                </button>
            </div>

            <!-- Today's Summary -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-white rounded-xl card-shadow p-3 text-center">
                    <div class="text-xl font-bold text-purple-600" id="todayQty">0</div>
                    <div class="text-gray-600 text-xs mt-1">Quantity</div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-3 text-center">
                    <div class="text-xl font-bold text-green-600" id="todayRevenue">‚Çπ0</div>
                    <div class="text-gray-600 text-xs mt-1">Revenue</div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-3 text-center">
                    <div class="text-xl font-bold text-blue-600" id="todayOrders">0</div>
                    <div class="text-gray-600 text-xs mt-1">Orders</div>
                </div>
            </div>

            <!-- Sales History -->
            <div class="bg-white rounded-xl card-shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">üìä Sales History</h2>
                    <button onclick="downloadSalesData()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                        üì• Download
                    </button>
                </div>
                
                <div class="mobile-scroll">
                    <table class="w-full mobile-table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Date</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Store</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Product</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Qty</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Total</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistory">
                            <!-- Sales data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="gradient-bg text-white p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold">üëë Admin Panel</h1>
                    <p id="adminCurrentDate" class="text-purple-100 text-xs"></p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-purple-100">Admin</p>
                    <div class="flex items-center space-x-1 mt-1">
                        <button onclick="manualSync()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs" title="Sync data">üîÑ</button>
                        <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-1 rounded text-xs">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3">
            <!-- Navigation Tabs - Responsive Design -->
            <div class="bg-white rounded-xl card-shadow p-2 mb-4">
                <!-- Mobile View: Horizontal Scroll -->
                <div class="md:hidden">
                    <div class="flex overflow-x-auto space-x-1 pb-2 mobile-scroll">
                        <button onclick="showTab('dashboard')" id="dashboardTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-purple-600 text-white whitespace-nowrap">üìä Dashboard</button>
                        <button onclick="showTab('reports')" id="reportsTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üìà Reports</button>
                        <button onclick="showTab('sales')" id="salesTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üí∞ Sales</button>
                        <button onclick="showTab('staff')" id="staffTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üë• Staff</button>
                        <button onclick="showTab('attendance')" id="attendanceTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üìÖ Attendance</button>
                        <button onclick="showTab('salary')" id="salaryTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üí∞ Salary</button>
                        <button onclick="showTab('products')" id="productsTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üß¥ Products</button>
                        <button onclick="showTab('stores')" id="storesTab" class="tab-button flex-shrink-0 px-3 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 whitespace-nowrap">üè™ Stores</button>
                    </div>
                </div>
                
                <!-- Desktop/Tablet View: Grid Layout -->
                <div class="hidden md:block">
                    <div class="grid grid-cols-3 gap-1 mb-2">
                        <button onclick="showTab('dashboard')" id="dashboardTab" class="px-2 py-2 rounded text-xs font-semibold bg-purple-600 text-white hover-effects">üìä Dashboard</button>
                        <button onclick="showTab('reports')" id="reportsTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üìà Reports</button>
                        <button onclick="showTab('sales')" id="salesTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üí∞ Sales</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button onclick="showTab('staff')" id="staffTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üë• Staff</button>
                        <button onclick="showTab('attendance')" id="attendanceTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üìÖ Attendance</button>
                        <button onclick="showTab('salary')" id="salaryTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üí∞ Salary</button>
                    </div>
                    <div class="grid grid-cols-2 gap-1 mt-1">
                        <button onclick="showTab('products')" id="productsTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üß¥ Products</button>
                        <button onclick="showTab('stores')" id="storesTab" class="px-2 py-2 rounded text-xs font-semibold bg-gray-200 text-gray-700 hover-effects">üè™ Stores</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardContent" class="tab-content">
                <!-- Summary Cards - Responsive -->
                <div class="grid mobile-grid tablet-grid desktop-grid gap-3 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-2xl card-shadow mobile-padding tablet-padding desktop-padding text-center hover-effects desktop-shadow">
                        <div class="text-2xl md:text-3xl font-bold text-purple-600" id="totalQtyToday">0</div>
                        <div class="text-gray-600 mt-1 md:mt-2 mobile-text">Total Qty Today</div>
                    </div>
                    <div class="bg-white rounded-2xl card-shadow mobile-padding tablet-padding desktop-padding text-center hover-effects desktop-shadow">
                        <div class="text-2xl md:text-3xl font-bold text-green-600" id="totalRevenueToday">‚Çπ0</div>
                        <div class="text-gray-600 mt-1 md:mt-2 mobile-text">Total Revenue Today</div>
                    </div>
                    <div class="bg-white rounded-2xl card-shadow mobile-padding tablet-padding desktop-padding text-center hover-effects desktop-shadow">
                        <div class="text-2xl md:text-3xl font-bold text-blue-600" id="totalOrdersToday">0</div>
                        <div class="text-gray-600 mt-1 md:mt-2 mobile-text">Total Orders Today</div>
                    </div>
                    <div class="bg-white rounded-2xl card-shadow mobile-padding tablet-padding desktop-padding text-center hover-effects desktop-shadow">
                        <div class="text-2xl md:text-3xl font-bold text-orange-600" id="activePromotors">0</div>
                        <div class="text-gray-600 mt-1 md:mt-2 mobile-text">Active Promoters</div>
                    </div>
                </div>

                <!-- Top Performer -->
                <div class="bg-white rounded-xl card-shadow p-4 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">üèÜ Today's Top Performer</h2>
                    <div id="topPerformer" class="text-center py-4">
                        <div class="text-3xl mb-2">üéØ</div>
                        <div class="text-lg font-bold text-purple-600" id="topPerformerName">Loading...</div>
                        <div class="text-gray-600 text-sm" id="topPerformerStats">Calculating performance...</div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="bg-white rounded-xl card-shadow p-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">üìä Download Reports</h2>
                    <div class="space-y-2">
                        <button onclick="downloadDailyReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                            üìÖ Daily Report (CSV)
                        </button>
                    </div>
                </div>

                <!-- Google Drive Backup -->
                <div class="bg-white rounded-xl card-shadow p-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-3">üìÅ Google Drive Backup</h2>
                    <div class="space-y-2">
                        <button onclick="downloadGoogleDriveBackup()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
                            üìÅ Download Backup File
                        </button>
                        <button onclick="restoreFromGoogleDriveBackup()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm">
                            üìÇ Restore from Backup
                        </button>
                        <a href="https://drive.google.com/drive/folders/1W4FuhXKsGFAEgpcmg1mh8AIhtEGMOljI?usp=drive_link" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm text-center">
                            üîó Open Google Drive Folder
                        </a>
                    </div>
                    <div class="mt-3 p-2 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-700">
                            üí° <strong>Auto-backup:</strong> Your data is automatically prepared for Google Drive backup after each save. Click "Download Backup File" and upload to your Drive folder for cloud storage.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsContent" class="tab-content hidden">
                <div class="bg-white rounded-xl card-shadow p-4 mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">üìà Sales Reports</h2>
                    
                    <!-- Report Type Selection -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                            <select id="reportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="daily">Daily Report</option>
                                <option value="monthly">Monthly Report</option>
                                <option value="product">Product-wise Report</option>
                                <option value="staff">Staff-wise Report</option>
                                <option value="store">Store-wise Report</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                            <input type="date" id="reportDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <!-- Generate Report Button -->
                    <button onclick="generateReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg mb-4 text-sm">
                        üìä Generate Report
                    </button>
                    
                    <!-- Download Options -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="downloadReportPDF()" id="pdfDownloadBtn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm">
                            üìÑ Download PDF
                        </button>
                        <button onclick="downloadReportExcel()" id="excelDownloadBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-sm">
                            üìä Download Excel
                        </button>
                    </div>
                    
                    <!-- Firebase Data Viewer -->
                    <div class="border-t pt-4">
                        <h3 class="text-md font-bold text-gray-800 mb-2">üî• Firebase Database Viewer</h3>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="viewFirebaseData('employees')" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                                üë• View Staff Data
                            </button>
                            <button onclick="viewFirebaseData('sales')" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm">
                                üí∞ View Sales Data
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="viewFirebaseData('products')" class="bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg text-sm">
                                üß¥ View Products Data
                            </button>
                            <button onclick="viewFirebaseData('stores')" class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-lg text-sm">
                                üè™ View Stores Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Master Data Download -->
                    <div class="border-t pt-4">
                        <h3 class="text-md font-bold text-gray-800 mb-2">üóÇÔ∏è Master Data Export</h3>
                        <button onclick="downloadMasterData()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg text-sm">
                            üì• Download All Data (Excel)
                        </button>
                    </div>
                </div>
                
                <!-- Report Display Area -->
                <div class="bg-white rounded-xl card-shadow p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800" id="reportTitle">Select a report type to view data</h3>
                        <div class="text-sm text-gray-600" id="reportSummary"></div>
                    </div>
                    
                    <div class="mobile-scroll">
                        <div id="reportContent" class="text-center text-gray-500 py-8">
                            Select report type and click "Generate Report" to view data
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Management Tab -->
            <div id="salesContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üí∞ Sales Management</h2>
                        <div class="flex space-x-2">
                            <input type="date" id="filterDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <button onclick="filterByDate()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">Filter</button>
                            <button onclick="clearFilter()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">Clear</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Employee</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Store</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Product</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Qty</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Price</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Total</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allSalesData">
                                <!-- All sales data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Staff Management Tab -->
            <div id="staffContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üë• Staff Management</h2>
                        <button onclick="showAddStaffModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            ‚ûï Add New Staff
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Username</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Phone</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffData">
                                <!-- Staff data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Management Tab -->
            <div id="productsContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üß¥ Products Management</h2>
                        <button onclick="showAddProductModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            ‚ûï Add New Product
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Product Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Category</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Price</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Stock</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsData">
                                <!-- Products data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Management Tab -->
            <div id="attendanceContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üìÖ Attendance Management</h2>
                        <div class="flex space-x-2">
                            <input type="date" id="attendanceDate" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <button onclick="markAllPresent()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">‚úÖ All Present</button>
                            <button onclick="markAllAbsent()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm">‚ùå All Absent</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Employee Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Check In</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Check Out</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Hours</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceData">
                                <!-- Attendance data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Salary Management Tab -->
            <div id="salaryContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üí∞ Salary Reports</h2>
                        <div class="flex space-x-2">
                            <select id="salaryMonth" onchange="generateSalaryReport()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Select Month</option>
                            </select>
                            <button onclick="downloadSalaryReport()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm">üì• Download</button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white text-center">
                            <div class="text-2xl font-bold" id="totalSalaryAmount">‚Çπ0</div>
                            <div class="text-blue-100 text-sm">Total Salary</div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white text-center">
                            <div class="text-2xl font-bold" id="totalEmployeesCount">0</div>
                            <div class="text-green-100 text-sm">Total Employees</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-4 text-white text-center">
                            <div class="text-2xl font-bold" id="avgSalaryAmount">‚Çπ0</div>
                            <div class="text-purple-100 text-sm">Average Salary</div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-4 text-white text-center">
                            <div class="text-2xl font-bold" id="topPerformerSalary">‚Çπ0</div>
                            <div class="text-orange-100 text-sm">Top Earner</div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Employee Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Salary Type</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Base Amount</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Performance</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Present Days</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Calculated Salary</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody id="salaryReportData">
                                <!-- Salary data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stores Management Tab -->
            <div id="storesContent" class="tab-content hidden">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">üè™ Stores Management</h2>
                        <button onclick="showAddStoreModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            ‚ûï Add New Store
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Store Name</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Location</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Manager</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Phone</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="storesData">
                                <!-- Stores data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 z-50 modal">
        <div class="bg-white rounded-xl p-4 w-full max-w-sm max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-3" id="staffModalTitle">Add New Staff</h3>
            <form id="staffForm">
                <input type="hidden" id="staffId">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="staffEmpId" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter username" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="staffName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter full name" required>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="staffPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Phone number" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="staffPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Password" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="staffEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter email" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Salary Type</label>
                        <select id="staffSalaryType" onchange="updateSalaryFields()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="fixed">Fixed Salary</option>
                            <option value="quantity">Per Quantity Sold</option>
                            <option value="value">Commission Based</option>
                            <option value="attendance">Per Present Day</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1" id="salaryAmountLabel">Monthly Salary (‚Çπ)</label>
                        <input type="number" id="staffSalaryAmount" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Amount" step="0.01" required>
                        <div class="text-xs text-gray-500 mt-1" id="salaryHelpText">Monthly fixed salary</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                        <select id="staffStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-2 mt-4">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm">Save</button>
                    <button type="button" onclick="hideStaffModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-3 rounded-lg text-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="productModalTitle">Add New Product</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <input type="text" id="productNameInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter product name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="productCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            <option value="">Select Category</option>
                            <option value="Floral">Floral</option>
                            <option value="Woody">Woody</option>
                            <option value="Fresh">Fresh</option>
                            <option value="Oriental">Oriental</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price (‚Çπ)</label>
                        <input type="number" id="productPrice" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter price" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity</label>
                        <input type="number" id="productStock" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter stock quantity" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="productStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">Save</button>
                    <button type="button" onclick="hideProductModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Store Modal -->
    <div id="storeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="storeModalTitle">Add New Store</h3>
            <form id="storeForm">
                <input type="hidden" id="storeId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                        <input type="text" id="storeNameInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter store name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" id="storeLocation" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter location" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Manager Name</label>
                        <input type="text" id="storeManager" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter manager name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="storePhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Enter phone number" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="storeStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">Save</button>
                    <button type="button" onclick="hideStoreModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Data Viewer Modal -->
    <div id="firebaseDataModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="firebaseDataTitle">Firebase Data Viewer</h3>
                <button onclick="hideFirebaseDataModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-4 flex justify-between items-center">
                <div class="text-sm text-gray-600" id="firebaseDataInfo">Loading data...</div>
                <button onclick="refreshFirebaseData()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    üîÑ Refresh
                </button>
            </div>
            
            <div class="overflow-auto max-h-96 border rounded-lg">
                <pre id="firebaseDataContent" class="p-4 text-xs bg-gray-50 whitespace-pre-wrap">Loading...</pre>
            </div>
            
            <div class="mt-4 flex justify-end">
                <button onclick="downloadFirebaseData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm mr-2">
                    üì• Download JSON
                </button>
                <button onclick="hideFirebaseDataModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Sale Modal -->
    <div id="editSaleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Sale</h3>
            <form id="editSaleForm">
                <input type="hidden" id="editSaleId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="editSaleDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Store</label>
                        <select id="editSaleStore" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            <option value="">Select Store</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="editSaleProduct" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                        <input type="number" id="editSaleQuantity" class="w-full px-4 py-3 border border-gray-300 rounded-lg" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price</label>
                        <input type="number" id="editSalePrice" class="w-full px-4 py-3 border border-gray-300 rounded-lg" step="0.01">
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Update</button>
                    <button type="button" onclick="hideEditSaleModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
    üåê DEPLOYMENT INSTRUCTIONS FOR MULTI-LOCATION ACCESS:
    
    üìã OPTION 1: GitHub Pages (FREE & RECOMMENDED)
    1. Create a GitHub account at github.com
    2. Create a new repository named "eden-sales-tracker"
    3. Upload this HTML file as "index.html"
    4. Go to Settings ‚Üí Pages ‚Üí Source: Deploy from branch ‚Üí main
    5. Your link will be: https://yourusername.github.io/eden-sales-tracker
    
    üìã OPTION 2: Netlify (FREE)
    1. Go to netlify.com and sign up
    2. Drag and drop this HTML file
    3. Get instant link like: https://amazing-name-123456.netlify.app
    
    üìã OPTION 3: Vercel (FREE)
    1. Go to vercel.com and sign up
    2. Import from GitHub or upload file
    3. Get link like: https://eden-sales-tracker.vercel.app
    
    üìã OPTION 4: Firebase Hosting (FREE)
    1. Go to console.firebase.google.com
    2. Create project ‚Üí Hosting ‚Üí Get started
    3. Upload this file as index.html
    4. Get link like: https://your-project.web.app
    
    üîß MOBILE & DESKTOP OPTIMIZATION:
    ‚úÖ Responsive design for all screen sizes
    ‚úÖ Touch-friendly buttons for mobile
    ‚úÖ Optimized layouts for tablets
    ‚úÖ Enhanced desktop experience
    ‚úÖ PWA-ready for mobile app-like experience
    
    üîí SECURITY NOTES:
    - Update Firebase rules for production
    - Use environment variables for API keys
    - Enable HTTPS (automatic with above platforms)
    - Consider adding authentication
    -->
    
    <script>
        let currentUser = null;
        let isAdmin = false;
        let currentEditingSale = null;
        let currentReportData = [];
        let salaryReportCache = [];

        // Firebase data cache
        let employeesCache = {};
        let productsCache = [];
        let storesCache = [];
        let salesCache = [];
        let attendanceCache = [];
        
        // Device detection for responsive behavior (hidden from UI)
        const isMobile = window.innerWidth <= 768;
        const isTablet = window.innerWidth > 768 && window.innerWidth <= 1024;
        const isDesktop = window.innerWidth > 1024;

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'eden-sales-v1';
                    const urlsToCache = ['./', 'https://cdn.tailwindcss.com'];
                    
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('‚úÖ PWA Service Worker registered successfully');
                    })
                    .catch(function(error) {
                        console.log('‚ùå PWA Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            setupEventListeners();
            
            // Add PWA install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install button after 5 seconds
                setTimeout(() => {
                    if (deferredPrompt && !localStorage.getItem('pwa_install_dismissed')) {
                        const installBanner = document.createElement('div');
                        installBanner.innerHTML = `
                            <div class="fixed bottom-4 left-4 right-4 bg-purple-600 text-white p-3 rounded-lg shadow-lg z-50 flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">üì±</span>
                                    <span class="text-sm">Install Eden Sales App for better experience!</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="installPWA()" class="bg-white text-purple-600 px-3 py-1 rounded text-sm font-semibold">Install</button>
                                    <button onclick="dismissInstall()" class="text-purple-200 hover:text-white">‚úï</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(installBanner);
                        
                        window.installPWA = function() {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('‚úÖ PWA installed successfully');
                                }
                                deferredPrompt = null;
                                document.body.removeChild(installBanner);
                            });
                        };
                        
                        window.dismissInstall = function() {
                            localStorage.setItem('pwa_install_dismissed', 'true');
                            document.body.removeChild(installBanner);
                        };
                    }
                }, 5000);
            });
            
            // FRESH START: Clear all existing data
            console.log('üßπ Clearing all existing data for fresh start...');
            localStorage.removeItem('eden_app_data');
            localStorage.removeItem('eden_sales_backup');
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('eden_')) {
                    localStorage.removeItem(key);
                }
            });
            console.log('‚úÖ All existing data cleared');
            
            // Initialize with empty data
            employeesCache = {};
            productsCache = [];
            storesCache = [];
            salesCache = [];
            attendanceCache = [];
            
            // Update time every second
            setInterval(updateCurrentDate, 1000);
            
            // Wait for Firebase to be ready
            setTimeout(() => {
                if (window.db) {
                    console.log('Firebase connected successfully!');
                    initializeFirebaseData();
                } else {
                    console.error('Firebase not initialized. Please check your configuration.');
                    alert('Firebase connection failed. Please check your configuration.');
                }
            }, 1000);
            
            // Auto-save to localStorage every 10 seconds
            setInterval(saveToLocalStorage, 10000);
            
            // Check for daily backup every hour
            setInterval(checkDailyBackup, 3600000); // 1 hour = 3600000ms
            
            // Initial backup check
            setTimeout(checkDailyBackup, 5000);
        });

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ENHANCED: Multi-device data persistence with Firebase priority
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    employees: employeesCache,
                    products: productsCache,
                    stores: storesCache,
                    sales: salesCache,
                    attendance: attendanceCache,
                    timestamp: new Date().toISOString(),
                    googleDriveFolder: 'https://drive.google.com/drive/folders/1W4FuhXKsGFAEgpcmg1mh8AIhtEGMOljI?usp=drive_link'
                };
                
                // Save to localStorage for current device
                localStorage.setItem('eden_app_data', JSON.stringify(dataToSave));
                
                // CRITICAL: Also save to Firebase for cross-device sync
                saveToFirebaseForSync(dataToSave);
                
                console.log('üíæ Data saved to localStorage and Firebase');
                
                // Check for daily backup (3 AM)
                checkDailyBackup();
            } catch (error) {
                console.error('‚ùå Failed to save to localStorage:', error);
            }
        }

        // ENHANCED: Real-time cross-device sales syncing with Firebase
        async function saveToFirebaseForSync(data) {
            try {
                // Enhanced Firebase connection check
                if (!window.db || !window.firestore) {
                    console.log('üì± Firebase not initialized - using local storage only');
                    showSyncNotification('üì± Local mode - Firebase not connected');
                    return;
                }

                // Test Firebase connection with a simple read
                try {
                    const testRef = window.firestore.doc(window.db, 'system', 'connection_test');
                    await window.firestore.getDoc(testRef);
                    console.log('üî• Firebase connection verified');
                } catch (connectionError) {
                    console.warn('‚ùå Firebase connection test failed:', connectionError);
                    
                    if (connectionError.code === 'permission-denied') {
                        showSyncNotification('üîí Firebase permissions needed - using local storage');
                    } else if (connectionError.code === 'unavailable') {
                        showSyncNotification('üåê Firebase offline - data saved locally');
                    } else {
                        showSyncNotification('‚ùå Firebase error - using local storage');
                    }
                    return;
                }

                console.log('üîÑ Starting Firebase sync for cross-device access...');
                
                // CRITICAL: Save ALL sales to Firebase with real-time sync
                let salesSynced = 0;
                for (const sale of data.sales) {
                    try {
                        // Use setDoc with merge for real-time updates
                        if (sale.id && !sale.id.startsWith('offline_temp_')) {
                            const docRef = window.firestore.doc(window.db, 'sales', sale.id);
                            await window.firestore.setDoc(docRef, {
                                username: sale.username,
                                employeeName: sale.employeeName,
                                date: sale.date,
                                storeName: sale.storeName,
                                productName: sale.productName,
                                quantity: sale.quantity,
                                price: sale.price,
                                total: sale.total,
                                timestamp: sale.timestamp,
                                createdAt: sale.createdAt,
                                syncedAt: new Date().toISOString(),
                                deviceId: navigator.userAgent.substring(0, 50),
                                lastModified: Date.now() // For real-time detection
                            }, { merge: true });
                            salesSynced++;
                        }
                    } catch (saleError) {
                        console.warn('Sale sync failed for ID:', sale.id, saleError);
                    }
                }
                
                // Save employees for login sync with real-time updates
                let employeesSynced = 0;
                for (const [username, emp] of Object.entries(data.employees)) {
                    try {
                        if (emp.id) {
                            const docRef = window.firestore.doc(window.db, 'employees', emp.id);
                            await window.firestore.setDoc(docRef, {
                                ...emp,
                                lastModified: Date.now(),
                                syncedAt: new Date().toISOString()
                            }, { merge: true });
                            employeesSynced++;
                        }
                    } catch (empError) {
                        console.warn('Employee sync failed:', empError);
                    }
                }
                
                // CRITICAL: Update sync timestamp for other devices to detect changes
                try {
                    const syncDocRef = window.firestore.doc(window.db, 'system', 'lastSync');
                    await window.firestore.setDoc(syncDocRef, {
                        timestamp: Date.now(),
                        lastSyncBy: currentUser || 'unknown',
                        salesCount: data.sales.length,
                        employeesCount: Object.keys(data.employees).length,
                        syncedAt: new Date().toISOString(),
                        connectionStatus: 'connected'
                    }, { merge: true });
                    console.log('‚úÖ Sync timestamp updated for real-time detection');
                } catch (syncError) {
                    console.warn('Sync timestamp update failed:', syncError);
                }
                
                console.log(`‚úÖ Firebase sync completed: ${salesSynced} sales, ${employeesSynced} employees`);
                
                // Show success notification
                if (salesSynced > 0 || employeesSynced > 0) {
                    showSyncNotification(`‚úÖ ${salesSynced} sales + ${employeesSynced} staff synced to Firebase`);
                } else {
                    showSyncNotification('‚úÖ Firebase connected - data synced');
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase sync failed (data still saved locally):', error);
                
                // Better error messages based on error type
                if (error.code === 'permission-denied') {
                    showSyncNotification('üîí Firebase permissions needed - data saved locally');
                } else if (error.code === 'unavailable') {
                    showSyncNotification('üåê Firebase offline - data saved locally');
                } else if (error.message.includes('network')) {
                    showSyncNotification('üì∂ Network error - data saved locally');
                } else {
                    showSyncNotification('‚ö†Ô∏è Firebase error - data saved locally');
                }
            }
        }

        function showSyncNotification(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div class="fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
                    ${message}
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Daily 3 AM Auto-Backup System
        function checkDailyBackup() {
            const now = new Date();
            const lastBackup = localStorage.getItem('eden_last_backup_date');
            const today = now.toISOString().split('T')[0];
            
            // Check if it's 3 AM and we haven't backed up today
            if (now.getHours() === 3 && lastBackup !== today) {
                performDailyBackup();
            }
            
            // Also check every hour if we missed the 3 AM window
            if (!lastBackup || lastBackup !== today) {
                const timeSince3AM = now.getHours() >= 3 ? now.getHours() - 3 : (24 - 3) + now.getHours();
                if (timeSince3AM <= 1) { // Within 1 hour of 3 AM
                    performDailyBackup();
                }
            }
        }

        function performDailyBackup() {
            try {
                const data = {
                    employees: employeesCache,
                    products: productsCache,
                    stores: storesCache,
                    sales: salesCache,
                    attendance: attendanceCache,
                    timestamp: new Date().toISOString()
                };

                const backupContent = {
                    ...data,
                    backupInfo: {
                        appName: 'Eden Perfume Sales Tracker',
                        backupDate: new Date().toISOString(),
                        version: '2.0',
                        totalSales: data.sales.length,
                        totalEmployees: Object.keys(data.employees).length,
                        totalProducts: data.products.length,
                        totalStores: data.stores.length,
                        backupType: 'Daily Auto-Backup (3 AM)'
                    }
                };

                // Create backup file
                const backupJson = JSON.stringify(backupContent, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                // Auto-download the backup file
                const a = document.createElement('a');
                a.href = url;
                a.download = `Eden_Auto_Backup_${new Date().toISOString().split('T')[0]}_3AM.json`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Mark backup as completed for today
                localStorage.setItem('eden_last_backup_date', new Date().toISOString().split('T')[0]);
                
                console.log('‚úÖ Daily 3 AM backup completed automatically');
                
                // Show subtle notification (no popup)
                showBackupNotification('‚úÖ Daily backup completed - file downloaded automatically');
                
            } catch (error) {
                console.error('‚ùå Daily backup failed:', error);
            }
        }

        function showBackupNotification(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm">
                    ${message}
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Download backup file for Google Drive
        function downloadGoogleDriveBackup() {
            try {
                const data = {
                    employees: employeesCache,
                    products: productsCache,
                    stores: storesCache,
                    sales: salesCache,
                    attendance: attendanceCache,
                    timestamp: new Date().toISOString(),
                    backupInfo: {
                        appName: 'Eden Perfume Sales Tracker',
                        backupDate: new Date().toISOString(),
                        version: '2.0',
                        totalSales: salesCache.length,
                        totalEmployees: Object.keys(employeesCache).length,
                        totalProducts: productsCache.length,
                        totalStores: storesCache.length,
                        googleDriveFolder: 'https://drive.google.com/drive/folders/1W4FuhXKsGFAEgpcmg1mh8AIhtEGMOljI?usp=drive_link',
                        instructions: 'Upload this file to your Google Drive folder for cloud backup'
                    }
                };
                
                const backupJson = JSON.stringify(data, null, 2);
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Eden_Sales_Backup_${new Date().toISOString().split('T')[0]}_${new Date().toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                alert('üìÅ Backup downloaded successfully!\n\nüìÇ Next Steps:\n1. Go to your Google Drive folder\n2. Upload the downloaded JSON file\n3. Your data is now safely backed up in the cloud!\n\nüîó Google Drive Folder:\nhttps://drive.google.com/drive/folders/1W4FuhXKsGFAEgpcmg1mh8AIhtEGMOljI');
                
            } catch (error) {
                console.error('‚ùå Backup download failed:', error);
                alert('Error creating backup file. Please try again.');
            }
        }

        // Restore from Google Drive backup
        function restoreFromGoogleDriveBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            // Validate backup data
                            if (backupData.backupInfo && backupData.backupInfo.appName === 'Eden Perfume Sales Tracker') {
                                // Restore data
                                if (backupData.employees) employeesCache = backupData.employees;
                                if (backupData.products) productsCache = backupData.products;
                                if (backupData.stores) storesCache = backupData.stores;
                                if (backupData.sales) salesCache = backupData.sales;
                                if (backupData.attendance) attendanceCache = backupData.attendance;
                                
                                // Save to localStorage
                                saveToLocalStorage();
                                
                                // Refresh UI
                                loadDropdownOptions();
                                if (isAdmin) {
                                    loadAdminData();
                                } else {
                                    loadEmployeeSalesData();
                                }
                                
                                alert(`‚úÖ Data restored successfully from Google Drive backup!\n\nüìä Restored Data:\n‚Ä¢ ${Object.keys(employeesCache).length} employees\n‚Ä¢ ${productsCache.length} products\n‚Ä¢ ${storesCache.length} stores\n‚Ä¢ ${salesCache.length} sales records\n‚Ä¢ ${attendanceCache.length} attendance records\n\nüìÖ Backup Date: ${backupData.backupInfo.backupDate}`);
                                
                            } else {
                                alert('‚ùå Invalid backup file. Please select a valid Eden Sales Tracker backup file.');
                            }
                        } catch (error) {
                            console.error('‚ùå Backup restore failed:', error);
                            alert('‚ùå Error reading backup file. Please ensure it\'s a valid JSON file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('eden_app_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Load saved data
                    if (data.employees && Object.keys(data.employees).length > 0) {
                        employeesCache = data.employees;
                        console.log(`üì± Loaded ${Object.keys(employeesCache).length} employees from localStorage`);
                    }
                    
                    if (data.products && data.products.length > 0) {
                        productsCache = data.products;
                        console.log(`üì± Loaded ${productsCache.length} products from localStorage`);
                    }
                    
                    if (data.stores && data.stores.length > 0) {
                        storesCache = data.stores;
                        console.log(`üì± Loaded ${storesCache.length} stores from localStorage`);
                    }
                    
                    if (data.sales && data.sales.length > 0) {
                        salesCache = data.sales;
                        console.log(`üì± Loaded ${salesCache.length} sales from localStorage`);
                    }
                    
                    if (data.attendance && data.attendance.length > 0) {
                        attendanceCache = data.attendance;
                        console.log(`üì± Loaded ${attendanceCache.length} attendance records from localStorage`);
                    }
                    
                    console.log(`‚úÖ Data restored from localStorage (saved: ${data.timestamp})`);
                }
                
                // CRITICAL: Also try to load sales from backup locations
                try {
                    const salesBackup = localStorage.getItem('eden_sales_backup');
                    if (salesBackup) {
                        const backupSales = JSON.parse(salesBackup);
                        if (backupSales.length > salesCache.length) {
                            salesCache = backupSales;
                            console.log(`üì± Restored ${salesCache.length} sales from backup`);
                        }
                    }
                } catch (backupError) {
                    console.warn('‚ö†Ô∏è Sales backup restore failed:', backupError);
                }
                
                // Load dropdown options immediately
                loadDropdownOptions();
                
                if (!savedData) {
                    console.log('üì± No localStorage data found, will use defaults');
                }
            } catch (error) {
                console.error('‚ùå Failed to load from localStorage:', error);
            }
        }

        async function initializeFirebaseData() {
            try {
                showLoading();
                
                // First, try to load from localStorage for immediate access
                loadFromLocalStorage();
                
                // Test Firebase connection
                if (!window.db) {
                    throw new Error('Firebase not initialized');
                }
                
                console.log('üî• Loading data from Firebase for cross-device sync...');
                
                // Load Firebase data and merge with local data
                await loadAllFirebaseData();
                loadDropdownOptions();
                hideLoading();
                
                console.log('‚úÖ Firebase data loaded and synced successfully!');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                hideLoading();
                
                // Always load from localStorage as fallback
                loadFromLocalStorage();
                loadDropdownOptions();
                
                // Handle permission errors gracefully
                if (error.code === 'permission-denied') {
                    console.warn('‚ö†Ô∏è Firebase permissions not configured - using local data');
                    showBackupNotification('‚ö†Ô∏è Using local data - Firebase sync disabled');
                } else if (error.code === 'unavailable') {
                    console.warn('‚ö†Ô∏è Firebase temporarily unavailable - using local data');
                    showBackupNotification('‚ö†Ô∏è Firebase unavailable - using local data');
                } else if (error.message.includes('not initialized')) {
                    console.warn('‚ö†Ô∏è Firebase not initialized - using local data');
                    showBackupNotification('‚ö†Ô∏è Firebase not connected - using local data');
                } else {
                    console.log('üì± Using local data storage');
                    showBackupNotification('üì± Running in local mode');
                }
            }
        }

        function initializeOfflineMode() {
            console.log('üîÑ Initializing fresh database with clean data...');
            
            // Initialize with EMPTY data for fresh start
            employeesCache = {};
            productsCache = [];
            storesCache = [];
            salesCache = [];
            attendanceCache = [];

            loadDropdownOptions();
            console.log('‚úÖ Fresh database initialized - all data cleared');
            
            // Show fresh database indicator
            const freshIndicator = document.createElement('div');
            freshIndicator.innerHTML = 'üÜï Fresh Database - No Sample Data';
            freshIndicator.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white text-center py-1 text-xs z-50';
            document.body.appendChild(freshIndicator);
            
            // Auto-hide indicator after 5 seconds
            setTimeout(() => {
                if (freshIndicator.parentNode) {
                    freshIndicator.parentNode.removeChild(freshIndicator);
                }
            }, 5000);
        }

        async function loadAllFirebaseData() {
            try {
                console.log('üîÑ Starting to load Firebase data...');
                
                // Load employees with clean, non-duplicate storage
                try {
                    const employeesSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'employees'));
                    
                    // CLEAN: Reset cache to avoid duplicates
                    const newEmployeesCache = {};
                    const uniqueEmployees = new Map(); // Track unique employees by ID
                    
                    employeesSnapshot.forEach((doc) => {
                        const data = doc.data();
                        const username = data.username || doc.id;
                        const empData = { id: doc.id, ...data };
                        
                        // Store each employee only once with their primary username as key
                        if (!uniqueEmployees.has(doc.id)) {
                            uniqueEmployees.set(doc.id, empData);
                            newEmployeesCache[username] = empData; // Only primary username key
                            console.log(`üìã Loaded employee: ${data.name} (${username})`);
                        }
                    });
                    
                    // Only update cache if we got data from Firebase
                    if (uniqueEmployees.size > 0) {
                        employeesCache = newEmployeesCache;
                        console.log(`‚úÖ Loaded ${uniqueEmployees.size} unique employees from Firebase`);
                    } else {
                        console.log('üì± No employees in Firebase, keeping existing cache');
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è No employees collection found or error loading:', error);
                    // Don't reset employeesCache - keep existing data
                    if (Object.keys(employeesCache).length === 0) {
                        console.log('üîß Initializing with default sample employee');
                        employeesCache = {
                            'john_doe': {
                                id: 'sample_emp_1',
                                username: 'john_doe',
                                name: 'John Doe',
                                phone: '9876543210',
                                email: 'john@eden.com',
                                password: 'john123',
                                status: 'Active'
                            }
                        };
                    }
                }

                // Load products with fallback
                try {
                    const productsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'products'));
                    productsCache = [];
                    productsSnapshot.forEach((doc) => {
                        productsCache.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`Loaded ${productsCache.length} products`);
                } catch (error) {
                    console.warn('No products collection found, creating empty cache');
                    productsCache = [];
                }

                // Load stores with fallback
                try {
                    const storesSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'stores'));
                    storesCache = [];
                    storesSnapshot.forEach((doc) => {
                        storesCache.push({ id: doc.id, ...doc.data() });
                    });
                    console.log(`Loaded ${storesCache.length} stores`);
                } catch (error) {
                    console.warn('No stores collection found, creating empty cache');
                    storesCache = [];
                }

                // ENHANCED: Load sales with proper cross-device merging
                try {
                    let salesSnapshot;
                    try {
                        salesSnapshot = await window.firestore.getDocs(
                            window.firestore.query(
                                window.firestore.collection(window.db, 'sales'),
                                window.firestore.orderBy('timestamp', 'desc')
                            )
                        );
                    } catch (orderError) {
                        console.warn('OrderBy failed, loading sales without ordering');
                        salesSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'sales'));
                    }
                    
                    // CRITICAL: Proper cross-device sales merging
                    const firebaseSales = [];
                    salesSnapshot.forEach((doc) => {
                        const saleData = { id: doc.id, ...doc.data() };
                        firebaseSales.push(saleData);
                    });
                    
                    console.log(`üî• Found ${firebaseSales.length} sales in Firebase`);
                    console.log(`üì± Found ${salesCache.length} sales in local cache`);
                    
                    if (firebaseSales.length > 0) {
                        // Create a comprehensive merged list
                        const mergedSales = new Map();
                        
                        // First, add all local sales
                        salesCache.forEach(sale => {
                            if (sale.id) {
                                mergedSales.set(sale.id, sale);
                            }
                        });
                        
                        // Then, add/update with Firebase sales (Firebase takes priority)
                        firebaseSales.forEach(sale => {
                            if (sale.id) {
                                mergedSales.set(sale.id, sale);
                            }
                        });
                        
                        // Convert back to array and sort
                        salesCache = Array.from(mergedSales.values());
                        salesCache.sort((a, b) => {
                            const dateA = new Date(a.timestamp || a.createdAt || a.date);
                            const dateB = new Date(b.timestamp || b.createdAt || b.date);
                            return dateB - dateA;
                        });
                        
                        console.log(`‚úÖ MERGED SALES: ${salesCache.length} total (${firebaseSales.length} from Firebase + local)`);
                        
                        // Show sync notification
                        if (firebaseSales.length > 0) {
                            showSyncNotification(`üì• Loaded ${firebaseSales.length} sales from other devices`);
                        }
                    } else {
                        console.log('üì± No sales in Firebase, keeping existing cache');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Firebase sales loading failed:', error);
                    // Don't reset salesCache - keep existing data
                    if (salesCache.length === 0) {
                        console.log('üîß Initializing with empty sales cache');
                        salesCache = [];
                    }
                }

                console.log('All Firebase data loaded successfully');
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                // Don't throw error, allow app to continue with empty data
                employeesCache = {};
                productsCache = [];
                storesCache = [];
                salesCache = [];
            }
        }

        function updateSalaryFields() {
            const salaryType = document.getElementById('staffSalaryType').value;
            const labelElement = document.getElementById('salaryAmountLabel');
            const helpTextElement = document.getElementById('salaryHelpText');
            const amountInput = document.getElementById('staffSalaryAmount');
            
            switch(salaryType) {
                case 'fixed':
                    labelElement.textContent = 'Monthly Salary Amount (‚Çπ)';
                    helpTextElement.textContent = 'Enter monthly fixed salary amount';
                    amountInput.placeholder = 'e.g., 25000';
                    break;
                case 'quantity':
                    labelElement.textContent = 'Rate Per Unit Sold (‚Çπ)';
                    helpTextElement.textContent = 'Amount paid for each unit sold';
                    amountInput.placeholder = 'e.g., 50';
                    break;
                case 'value':
                    labelElement.textContent = 'Commission Percentage (%)';
                    helpTextElement.textContent = 'Percentage of total sales value';
                    amountInput.placeholder = 'e.g., 5';
                    break;
                case 'attendance':
                    labelElement.textContent = 'Daily Rate (‚Çπ)';
                    helpTextElement.textContent = 'Amount paid per present day';
                    amountInput.placeholder = 'e.g., 800';
                    break;
            }
        }

        function setupEventListeners() {
            // Staff form submission
            document.getElementById('staffForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveStaff();
            });

            // Product form submission
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProduct();
            });

            // Store form submission
            document.getElementById('storeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveStore();
            });

            // Edit sale form submission
            document.getElementById('editSaleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateSale();
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const currentDateElement = document.getElementById('currentDate');
            const adminCurrentDateElement = document.getElementById('adminCurrentDate');
            const saleDateElement = document.getElementById('saleDate');
            
            if (currentDateElement) {
                currentDateElement.textContent = `${dateStr} ‚Ä¢ ${timeStr}`;
            }
            if (adminCurrentDateElement) {
                adminCurrentDateElement.textContent = `${dateStr} ‚Ä¢ ${timeStr}`;
            }
            if (saleDateElement) {
                saleDateElement.value = now.toISOString().split('T')[0];
            }
        }

        function loadDropdownOptions() {
            // Keep collections empty for fresh start - no sample data
            console.log('üìã Products:', productsCache.length);
            console.log('üè™ Stores:', storesCache.length);
            console.log('üë• Staff:', Object.keys(employeesCache).length);
            console.log('üí∞ Sales:', salesCache.length);

            // Load products in dropdowns
            const productSelects = ['productName', 'editSaleProduct'];
            productSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Product</option>';
                    productsCache.filter(p => p.status === 'Active').forEach(product => {
                        select.innerHTML += `<option value="${product.name}" data-price="${product.price}">${product.name}</option>`;
                    });
                }
            });

            // Load stores in dropdowns
            const storeSelects = ['storeName', 'editSaleStore'];
            storeSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Store</option>';
                    storesCache.filter(s => s.status === 'Active').forEach(store => {
                        select.innerHTML += `<option value="${store.name}">${store.name}</option>`;
                    });
                }
            });
        }

        function setupProductPriceAutoFill() {
            const productSelect = document.getElementById('productName');
            const priceInput = document.getElementById('price');
            
            if (productSelect && priceInput) {
                productSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset.price) {
                        priceInput.value = selectedOption.dataset.price;
                    } else {
                        priceInput.value = '';
                    }
                });
            }
        }

        async function login() {
            const username = document.getElementById('employeeId').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert('Please enter both Username and Password');
                return;
            }

            showLoading();

            try {
                // Check for admin login (case insensitive)
                if (username.toLowerCase() === 'eden' && password === 'eden@123') {
                    isAdmin = true;
                    currentUser = 'eden';
                    showAdminPage();
                    await loadAdminData();
                    loadDropdownOptions();
                    hideLoading();
                    return;
                }

                // Debug: Show what's in the cache
                console.log('üîç Login attempt for username:', username);
                console.log('üìã Available usernames in cache:', Object.keys(employeesCache));

                // Check employee login with clean, simple lookup
                let foundEmployee = null;
                
                // Method 1: Direct username key lookup
                if (employeesCache[username]) {
                    const emp = employeesCache[username];
                    console.log('üéØ Found by direct lookup:', emp);
                    if (emp.password === password && emp.status === 'Active') {
                        foundEmployee = emp;
                        console.log('‚úÖ Password and status match - direct lookup');
                    } else {
                        console.log('‚ùå Password or status mismatch - direct lookup');
                        console.log('Expected password:', password, 'Found password:', emp.password);
                        console.log('Status:', emp.status);
                    }
                }
                
                // Method 2: Case-insensitive search as fallback
                if (!foundEmployee) {
                    console.log('üîÑ Trying case-insensitive search...');
                    Object.keys(employeesCache).forEach(key => {
                        const emp = employeesCache[key];
                        if (emp.username && emp.username.toLowerCase() === username.toLowerCase() && 
                            emp.password === password && emp.status === 'Active') {
                            foundEmployee = emp;
                            console.log('‚úÖ Found by case-insensitive search:', emp);
                        }
                    });
                }

                if (foundEmployee) {
                    currentUser = foundEmployee.username;
                    isAdmin = false;
                    const employeeNameElement = document.getElementById('employeeName');
                    if (employeeNameElement) {
                        employeeNameElement.textContent = foundEmployee.name;
                    }
                    showEmployeePage();
                    loadEmployeeSalesData();
                    loadDropdownOptions();
                    setupProductPriceAutoFill();
                    hideLoading();
                    console.log(`‚úÖ Employee ${foundEmployee.name} logged in successfully`);
                    alert(`Welcome ${foundEmployee.name}! üéâ`);
                } else {
                    hideLoading();
                    console.log(`‚ùå Login failed for username: ${username}`);
                    console.log('Available usernames:', Object.keys(employeesCache));
                    
                    // Show detailed error message
                    let errorMsg = `Login Failed ‚ùå\n\nUsername: ${username}\nPassword: ${password}\n\n`;
                    errorMsg += `Available usernames:\n`;
                    Object.keys(employeesCache).forEach(key => {
                        const emp = employeesCache[key];
                        errorMsg += `‚Ä¢ ${emp.username || key} (Status: ${emp.status})\n`;
                    });
                    errorMsg += `\nPlease check:\n1. Username spelling\n2. Password is correct\n3. Account is Active`;
                    
                    alert(errorMsg);
                }
            } catch (error) {
                hideLoading();
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        function showEmployeePage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('employeePage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
        }

        function showAdminPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('employeePage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('employeePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            // Clear form fields
            document.getElementById('employeeId').value = '';
            document.getElementById('password').value = '';
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));

            // Remove active class from all tabs
            const tabs = ['dashboardTab', 'reportsTab', 'salaryTab', 'salesTab', 'staffTab', 'attendanceTab', 'productsTab', 'storesTab'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                if (element) {
                    element.classList.remove('bg-purple-600', 'text-white');
                    element.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            // Show selected tab content
            const tabContent = document.getElementById(tabName + 'Content');
            if (tabContent) {
                tabContent.classList.remove('hidden');
            }

            // Add active class to selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            if (activeTab) {
                activeTab.classList.remove('bg-gray-200', 'text-gray-700');
                activeTab.classList.add('bg-purple-600', 'text-white');
            }

            // Load data for specific tabs
            if (tabName === 'staff') {
                loadStaffData();
            } else if (tabName === 'attendance') {
                loadAttendanceData();
            } else if (tabName === 'salary') {
                loadSalaryData();
            } else if (tabName === 'products') {
                loadProductsData();
            } else if (tabName === 'stores') {
                loadStoresData();
            } else if (tabName === 'sales') {
                loadAllSalesData();
            } else if (tabName === 'reports') {
                initializeReports();
            }
        }

        async function addSale() {
            const date = document.getElementById('saleDate').value;
            const storeName = document.getElementById('storeName').value;
            const productName = document.getElementById('productName').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const price = parseFloat(document.getElementById('price').value) || 0;

            if (!date || !storeName || !productName || !quantity) {
                alert('Please fill in all required fields (Date, Store Name, Product Name, Quantity)');
                return;
            }

            // IMMEDIATE FEEDBACK - Show saving status
            const saveButton = document.querySelector('button[onclick="addSale()"]');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = 'üíæ Saving...';
            saveButton.disabled = true;

            try {
                const sale = {
                    username: currentUser,
                    employeeName: employeesCache[currentUser] ? employeesCache[currentUser].name : 'Unknown',
                    date: date,
                    storeName: storeName,
                    productName: productName,
                    quantity: quantity,
                    price: price,
                    total: quantity * price,
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };

                // Generate unique ID
                let saleId = 'sale_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                console.log('üíæ SAVING SALE:', sale);

                // CRITICAL: Update local cache FIRST (immediate save)
                const completeSale = { id: saleId, ...sale };
                salesCache.unshift(completeSale);
                console.log('üìã Sale added to cache. Total sales:', salesCache.length);

                // IMMEDIATE: Save to localStorage
                saveToLocalStorage();
                
                // IMMEDIATE: Update UI to show the new sale
                loadEmployeeSalesData();

                // IMMEDIATE Firebase sync for cross-device access
                setTimeout(async () => {
                    try {
                        // Enhanced Firebase connection check
                        if (!window.db || !window.firestore) {
                            console.log('üì± Firebase not initialized - sale saved locally only');
                            showSyncNotification('üì± Sale saved locally - Firebase not connected');
                            return;
                        }

                        // Test Firebase connection first
                        try {
                            const testRef = window.firestore.doc(window.db, 'system', 'connection_test');
                            await window.firestore.getDoc(testRef);
                        } catch (connectionError) {
                            console.warn('‚ùå Firebase connection test failed:', connectionError);
                            
                            if (connectionError.code === 'permission-denied') {
                                showSyncNotification('üîí Sale saved locally - Firebase permissions needed');
                            } else if (connectionError.code === 'unavailable') {
                                showSyncNotification('üåê Sale saved locally - Firebase offline');
                            } else {
                                showSyncNotification('‚ùå Sale saved locally - Firebase connection error');
                            }
                            return;
                        }

                        console.log('üîÑ Syncing sale to Firebase for cross-device access...');
                        const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'sales'), {
                            ...sale,
                            syncedAt: new Date().toISOString(),
                            deviceId: navigator.userAgent.substring(0, 50) // Track which device created it
                        });
                        console.log('‚úÖ Sale synced to Firebase with ID:', docRef.id);
                        
                        // Update the sale ID in cache for future updates
                        const saleIndex = salesCache.findIndex(s => s.id === saleId);
                        if (saleIndex !== -1) {
                            salesCache[saleIndex].id = docRef.id;
                            salesCache[saleIndex].firebaseId = docRef.id;
                            saveToLocalStorage();
                        }
                        
                        // Show success notification
                        showSyncNotification('‚úÖ Sale synced to Firebase - available on all devices');
                        
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase sync failed (data still saved locally):', firebaseError);
                        
                        // Better error messages
                        if (firebaseError.code === 'permission-denied') {
                            showSyncNotification('üîí Sale saved locally - Firebase permissions needed');
                        } else if (firebaseError.code === 'unavailable') {
                            showSyncNotification('üåê Sale saved locally - Firebase offline');
                        } else if (firebaseError.message.includes('network')) {
                            showSyncNotification('üì∂ Sale saved locally - network error');
                        } else {
                            showSyncNotification('‚ö†Ô∏è Sale saved locally - will sync when Firebase is available');
                        }
                    }
                }, 100);

                // üîÑ AUTOMATIC ATTENDANCE: Mark employee as present
                await autoMarkAttendance(currentUser, date);

                // Additional backup - save sales separately
                try {
                    localStorage.setItem('eden_sales_backup', JSON.stringify(salesCache));
                    localStorage.setItem('eden_sales_' + currentUser, JSON.stringify(salesCache.filter(s => s.username === currentUser)));
                    console.log('üíæ Sales backed up to localStorage');
                } catch (storageError) {
                    console.error('‚ùå localStorage backup failed:', storageError);
                }

                // Clear form AFTER successful save
                document.getElementById('storeName').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('price').value = '';

                // Reset button
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;

                // SUCCESS FEEDBACK
                alert(`‚úÖ SALE SAVED SUCCESSFULLY!\n\nüìä Sale Details:\n‚Ä¢ Product: ${productName}\n‚Ä¢ Quantity: ${quantity}\n‚Ä¢ Store: ${storeName}\n‚Ä¢ Total: ‚Çπ${quantity * price}\n‚Ä¢ Date: ${date}\n\nüéØ Your sale is now visible in the sales history below!`);
                
                console.log('‚úÖ Sale save process completed successfully');
                
                // Force refresh the sales display
                setTimeout(() => {
                    loadEmployeeSalesData();
                }, 500);
                
            } catch (error) {
                // Reset button on error
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
                
                console.error('üí• Error adding sale:', error);
                alert(`‚ùå Error saving sale: ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        function loadEmployeeSalesData() {
            console.log('üîÑ Loading employee sales data...');
            console.log('Current user:', currentUser);
            console.log('Total sales in cache:', salesCache.length);
            
            const employeeSales = salesCache.filter(sale => sale.username === currentUser);
            console.log('Employee sales found:', employeeSales.length);
            
            // Calculate today's summary
            const today = new Date().toISOString().split('T')[0];
            const todaySales = employeeSales.filter(sale => sale.date === today);
            console.log('Today\'s sales:', todaySales.length);
            
            let todayQty = 0;
            let todayRevenue = 0;
            let todayOrders = todaySales.length;
            
            todaySales.forEach(sale => {
                todayQty += sale.quantity;
                todayRevenue += sale.total;
            });
            
            console.log('Today summary - Qty:', todayQty, 'Revenue:', todayRevenue, 'Orders:', todayOrders);
            
            const todayQtyElement = document.getElementById('todayQty');
            const todayRevenueElement = document.getElementById('todayRevenue');
            const todayOrdersElement = document.getElementById('todayOrders');
            
            if (todayQtyElement) {
                todayQtyElement.textContent = todayQty;
                console.log('‚úÖ Updated quantity display');
            }
            if (todayRevenueElement) {
                todayRevenueElement.textContent = `‚Çπ${todayRevenue.toLocaleString('en-IN')}`;
                console.log('‚úÖ Updated revenue display');
            }
            if (todayOrdersElement) {
                todayOrdersElement.textContent = todayOrders;
                console.log('‚úÖ Updated orders display');
            }
            
            // Load sales history with better error handling
            let historyHtml = '';
            if (employeeSales.length > 0) {
                historyHtml = employeeSales.map((sale, index) => {
                    console.log(`Processing sale ${index + 1}:`, sale);
                    return `
                        <tr class="border-b border-gray-100">
                            <td class="px-2 py-2 text-xs">${sale.date ? sale.date.split('-')[2] + '/' + sale.date.split('-')[1] : 'N/A'}</td>
                            <td class="px-2 py-2 text-xs">${sale.storeName ? (sale.storeName.length > 8 ? sale.storeName.substring(0, 8) + '...' : sale.storeName) : 'N/A'}</td>
                            <td class="px-2 py-2 text-xs">${sale.productName ? (sale.productName.length > 8 ? sale.productName.substring(0, 8) + '...' : sale.productName) : 'N/A'}</td>
                            <td class="px-2 py-2 text-xs font-semibold">${sale.quantity || 0}</td>
                            <td class="px-2 py-2 text-xs font-semibold text-green-600">‚Çπ${sale.total || 0}</td>
                            <td class="px-2 py-2 text-xs">
                                <span class="text-green-500 text-xs">‚úÖ Saved</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                historyHtml = '<tr><td colspan="6" class="px-2 py-4 text-center text-gray-500 text-xs">No sales data yet - Add your first sale above!</td></tr>';
            }
            
            const salesHistoryElement = document.getElementById('salesHistory');
            if (salesHistoryElement) {
                salesHistoryElement.innerHTML = historyHtml;
                console.log('‚úÖ Updated sales history table');
            } else {
                console.error('‚ùå Sales history element not found!');
            }
            
            console.log('‚úÖ Employee sales data loading completed');
        }

        async function loadAdminData() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesCache.filter(sale => sale.date === today);
            
            // Calculate totals
            let totalQty = 0;
            let totalRevenue = 0;
            let totalOrders = todaySales.length;
            let activePromotors = new Set();
            
            todaySales.forEach(sale => {
                totalQty += sale.quantity;
                totalRevenue += sale.total;
                activePromotors.add(sale.username);
            });
            
            const totalQtyTodayElement = document.getElementById('totalQtyToday');
            const totalRevenueTodayElement = document.getElementById('totalRevenueToday');
            const totalOrdersTodayElement = document.getElementById('totalOrdersToday');
            const activePromotorsElement = document.getElementById('activePromotors');
            
            if (totalQtyTodayElement) totalQtyTodayElement.textContent = totalQty;
            if (totalRevenueTodayElement) totalRevenueTodayElement.textContent = `‚Çπ${totalRevenue.toLocaleString('en-IN')}`;
            if (totalOrdersTodayElement) totalOrdersTodayElement.textContent = totalOrders;
            if (activePromotorsElement) activePromotorsElement.textContent = activePromotors.size;
            
            // Find top performer
            const performerStats = {};
            todaySales.forEach(sale => {
                if (!performerStats[sale.username]) {
                    performerStats[sale.username] = {
                        name: sale.employeeName,
                        quantity: 0,
                        revenue: 0,
                        orders: 0
                    };
                }
                performerStats[sale.username].quantity += sale.quantity;
                performerStats[sale.username].revenue += sale.total;
                performerStats[sale.username].orders += 1;
            });
            
            let topPerformer = null;
            let maxRevenue = 0;
            
            Object.keys(performerStats).forEach(username => {
                if (performerStats[username].revenue > maxRevenue) {
                    maxRevenue = performerStats[username].revenue;
                    topPerformer = performerStats[username];
                }
            });
            
            const topPerformerNameElement = document.getElementById('topPerformerName');
            const topPerformerStatsElement = document.getElementById('topPerformerStats');
            
            if (topPerformer) {
                if (topPerformerNameElement) topPerformerNameElement.textContent = topPerformer.name;
                if (topPerformerStatsElement) {
                    topPerformerStatsElement.textContent = 
                        `${topPerformer.quantity} units sold ‚Ä¢ ‚Çπ${topPerformer.revenue.toLocaleString('en-IN')} revenue ‚Ä¢ ${topPerformer.orders} orders`;
                }
            } else {
                if (topPerformerNameElement) topPerformerNameElement.textContent = 'No sales today';
                if (topPerformerStatsElement) topPerformerStatsElement.textContent = 'Waiting for first sale...';
            }
        }

        function loadAllSalesData(salesData = null) {
            const sales = salesData || salesCache;
            
            const allSalesHtml = sales.map(sale => `
                <tr class="border-b border-gray-100">
                    <td class="px-4 py-3 text-sm">${sale.date}</td>
                    <td class="px-4 py-3 text-sm">${sale.employeeName}</td>
                    <td class="px-4 py-3 text-sm">${sale.storeName}</td>
                    <td class="px-4 py-3 text-sm">${sale.productName}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${sale.quantity}</td>
                    <td class="px-4 py-3 text-sm">‚Çπ${sale.price.toLocaleString('en-IN')}</td>
                    <td class="px-4 py-3 text-sm font-semibold text-green-600">‚Çπ${sale.total.toLocaleString('en-IN')}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editSale('${sale.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">Edit</button>
                        <button onclick="deleteSale('${sale.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            const allSalesDataElement = document.getElementById('allSalesData');
            if (allSalesDataElement) {
                allSalesDataElement.innerHTML = allSalesHtml || '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">No sales data available</td></tr>';
            }
        }

        // Staff Management Functions
        function loadStaffData() {
            // Get unique employees only (avoid duplicates)
            const uniqueEmployees = new Map();
            
            Object.values(employeesCache).forEach(emp => {
                if (emp && emp.id && !uniqueEmployees.has(emp.id)) {
                    uniqueEmployees.set(emp.id, emp);
                }
            });
            
            const staffHtml = Array.from(uniqueEmployees.values()).map(emp => {
                const username = emp.username || emp.id;
                return `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-sm font-semibold">${username}</td>
                        <td class="px-4 py-3 text-sm">${emp.name}</td>
                        <td class="px-4 py-3 text-sm">${emp.phone}</td>
                        <td class="px-4 py-3 text-sm">${emp.email}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${emp.status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="editStaff('${emp.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">Edit</button>
                            <button onclick="deleteStaff('${emp.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const staffDataElement = document.getElementById('staffData');
            if (staffDataElement) {
                staffDataElement.innerHTML = staffHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No staff data available</td></tr>';
            }
        }

        function showAddStaffModal() {
            const staffModalTitleElement = document.getElementById('staffModalTitle');
            const staffFormElement = document.getElementById('staffForm');
            const staffIdElement = document.getElementById('staffId');
            const staffModalElement = document.getElementById('staffModal');
            
            if (staffModalTitleElement) staffModalTitleElement.textContent = 'Add New Staff';
            if (staffFormElement) staffFormElement.reset();
            if (staffIdElement) staffIdElement.value = '';
            if (staffModalElement) staffModalElement.classList.remove('hidden');
        }

        function editStaff(empId) {
            // Find employee by ID from unique employees only
            let emp = null;
            Object.values(employeesCache).forEach(e => {
                if (e && e.id === empId && !emp) {
                    emp = e; // Take first match only
                }
            });
            
            if (!emp) return;
            
            const staffModalTitleElement = document.getElementById('staffModalTitle');
            const staffIdElement = document.getElementById('staffId');
            const staffEmpIdElement = document.getElementById('staffEmpId');
            const staffNameElement = document.getElementById('staffName');
            const staffPhoneElement = document.getElementById('staffPhone');
            const staffEmailElement = document.getElementById('staffEmail');
            const staffPasswordElement = document.getElementById('staffPassword');
            const staffSalaryTypeElement = document.getElementById('staffSalaryType');
            const staffSalaryAmountElement = document.getElementById('staffSalaryAmount');
            const staffStatusElement = document.getElementById('staffStatus');
            const staffModalElement = document.getElementById('staffModal');
            
            if (staffModalTitleElement) staffModalTitleElement.textContent = 'Edit Staff';
            if (staffIdElement) staffIdElement.value = empId;
            if (staffEmpIdElement) staffEmpIdElement.value = emp.username;
            if (staffNameElement) staffNameElement.value = emp.name;
            if (staffPhoneElement) staffPhoneElement.value = emp.phone;
            if (staffEmailElement) staffEmailElement.value = emp.email;
            if (staffPasswordElement) staffPasswordElement.value = emp.password;
            if (staffSalaryTypeElement) staffSalaryTypeElement.value = emp.salaryType || 'fixed';
            if (staffSalaryAmountElement) staffSalaryAmountElement.value = emp.salaryAmount || 0;
            if (staffStatusElement) staffStatusElement.value = emp.status;
            if (staffModalElement) staffModalElement.classList.remove('hidden');
            
            // Update salary field labels
            updateSalaryFields();
        }

        let isSavingStaff = false; // Prevent duplicate saves
        
        async function saveStaff() {
            // Prevent duplicate saves
            if (isSavingStaff) {
                console.log('‚ö†Ô∏è Staff save already in progress, ignoring duplicate request');
                return;
            }
            
            // Disable the save button immediately
            const saveButton = document.querySelector('#staffForm button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<div class="loading"></div> Saving...';
            }
            
            const username = document.getElementById('staffEmpId').value.trim();
            const name = document.getElementById('staffName').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const password = document.getElementById('staffPassword').value.trim();
            const salaryType = document.getElementById('staffSalaryType').value;
            const salaryAmount = parseFloat(document.getElementById('staffSalaryAmount').value) || 0;
            const status = document.getElementById('staffStatus').value;
            const isEditing = document.getElementById('staffId').value;

            if (!username || !name || !phone || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }

            // Check if username already exists (only for new staff)
            if (!isEditing) {
                const existingUser = Object.values(employeesCache).find(emp => emp.username === username);
                if (existingUser) {
                    alert('Username already exists. Please use a different username.');
                    return;
                }
            }

            isSavingStaff = true; // Set flag to prevent duplicates
            showLoading();

            try {
                const employeeData = {
                    username: username,
                    name: name,
                    phone: phone,
                    email: email,
                    password: password,
                    salaryType: salaryType,
                    salaryAmount: salaryAmount,
                    status: status,
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };

                let empId = isEditing || 'emp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                let firebaseSaved = false;

                console.log('üîÑ STARTING STAFF SAVE PROCESS...');
                console.log('üìù Employee data:', employeeData);
                console.log('üÜî Target ID:', empId);

                // STEP 1: Firebase Save with Enhanced Error Handling
                try {
                    if (window.db && window.firestore) {
                        console.log('üî• Attempting Firebase save...');
                        
                        if (isEditing) {
                            // Update existing employee
                            const docRef = window.firestore.doc(window.db, 'employees', isEditing);
                            await window.firestore.updateDoc(docRef, employeeData);
                            empId = isEditing;
                            console.log('‚úÖ Staff UPDATED in Firebase with ID:', empId);
                        } else {
                            // Add new employee
                            const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'employees'), employeeData);
                            empId = docRef.id;
                            console.log('‚úÖ Staff ADDED to Firebase with ID:', empId);
                        }
                        
                        // CRITICAL: Verify Firebase save by reading back the document
                        try {
                            const verifyDocRef = window.firestore.doc(window.db, 'employees', empId);
                            const verifyDoc = await window.firestore.getDoc ? 
                                await window.firestore.getDoc(verifyDocRef) : 
                                await verifyDocRef.get();
                            
                            if (verifyDoc.exists()) {
                                const savedData = verifyDoc.data();
                                console.log('üîç Firebase verification SUCCESS - Document exists');
                                console.log('üìã Saved data:', savedData);
                                firebaseSaved = true;
                            } else {
                                console.error('‚ùå Firebase verification FAILED - Document not found');
                            }
                        } catch (verifyError) {
                            console.error('‚ùå Firebase verification error:', verifyError);
                        }
                        
                    } else {
                        console.log('üì± Firebase not available - using offline mode');
                    }
                } catch (firebaseError) {
                    console.error('‚ùå Firebase save FAILED:', firebaseError);
                    console.log('üì± Continuing in offline mode...');
                    
                    // Show Firebase error but continue
                    if (firebaseError.code === 'permission-denied') {
                        console.warn('‚ö†Ô∏è Firebase permissions not configured - data will be stored locally only');
                    }
                }

                // STEP 2: CLEAN Cache Storage (No Duplicates)
                console.log('üíæ STORING IN CACHE...');
                
                const finalEmployeeData = { id: empId, ...employeeData };
                
                // CLEAN: Store only with primary username key to avoid duplicates
                employeesCache[username] = finalEmployeeData;
                
                console.log('‚úÖ Stored with primary key:', username);

                // STEP 3: Clean up old entries if editing
                if (isEditing) {
                    console.log('üßπ Cleaning up old cache entries...');
                    // Find and remove old entry with different username
                    Object.keys(employeesCache).forEach(key => {
                        const emp = employeesCache[key];
                        if (emp && emp.id === isEditing && key !== username) {
                            console.log('üóëÔ∏è Removing old key:', key);
                            delete employeesCache[key];
                        }
                    });
                }

                // STEP 4: Simple Verification
                console.log('üîç VERIFICATION CHECKS:');
                console.log('Total employees in cache:', Object.keys(employeesCache).length);
                console.log('Cache keys:', Object.keys(employeesCache));
                
                const verifyTests = {
                    'Username key exists': !!employeesCache[username],
                    'Password match': employeesCache[username]?.password === password,
                    'Status correct': employeesCache[username]?.status === status,
                    'Name correct': employeesCache[username]?.name === name
                };
                
                console.log('üìä Verification results:', verifyTests);
                
                // STEP 5: Login Test
                const testEmployee = employeesCache[username];
                const loginTest = testEmployee && testEmployee.password === password && testEmployee.status === 'Active';
                console.log('üéØ LOGIN TEST:', loginTest ? 'PASSED ‚úÖ' : 'FAILED ‚ùå');
                
                if (!loginTest) {
                    console.error('‚ùå CRITICAL: Login test failed!');
                    console.log('Test employee data:', testEmployee);
                }

                // STEP 6: Force save to localStorage for immediate persistence
                saveToLocalStorage();
                
                // STEP 7: Force reload staff data to verify persistence
                await new Promise(resolve => setTimeout(resolve, 100)); // Small delay
                loadStaffData();

                hideLoading();
                hideStaffModal();
                
                // STEP 7: Success confirmation with detailed status
                const statusMsg = `‚úÖ STAFF ${isEditing ? 'UPDATED' : 'CREATED'} SUCCESSFULLY!\n\n` +
                    `üë§ EMPLOYEE DETAILS:\n` +
                    `Name: ${name}\n` +
                    `Username: ${username}\n` +
                    `Password: ${password}\n` +
                    `Status: ${status}\n` +
                    `ID: ${empId}\n\n` +
                    `üíæ STORAGE STATUS:\n` +
                    `Firebase: ${firebaseSaved ? '‚úÖ Saved' : '‚ùå Local Only'}\n` +
                    `Cache: ‚úÖ Stored (${Object.keys(verifyTests).filter(k => verifyTests[k]).length}/${Object.keys(verifyTests).length} checks passed)\n` +
                    `Login Ready: ${loginTest ? '‚úÖ YES' : '‚ùå NO'}\n\n` +
                    `üöÄ ${loginTest ? 'Staff can login immediately!' : 'Please check the data and try again.'}`;
                
                alert(statusMsg);
                
                // STEP 8: Additional logging for debugging
                console.log('üéâ STAFF SAVE COMPLETE:');
                console.log(`   Firebase Status: ${firebaseSaved ? 'SAVED' : 'LOCAL ONLY'}`);
                console.log(`   Cache Status: STORED`);
                console.log(`   Login Status: ${loginTest ? 'READY' : 'FAILED'}`);
                console.log(`   Employee ID: ${empId}`);
                console.log(`   Username: ${username}`);
                
            } catch (error) {
                hideLoading();
                console.error('üí• CRITICAL ERROR in saveStaff:', error);
                alert(`Error saving staff data: ${error.message}\n\nPlease try again or contact support.`);
            } finally {
                isSavingStaff = false; // Reset flag regardless of success/failure
                
                // Re-enable the save button
                const saveButton = document.querySelector('#staffForm button[type="submit"]');
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save';
                }
            }
        }

        async function deleteStaff(empId) {
            if (confirm('Are you sure you want to delete this staff member?')) {
                showLoading();
                
                try {
                    // Try Firebase, continue if it fails
                    try {
                        if (window.db && window.firestore) {
                            await window.firestore.deleteDoc(window.firestore.doc(window.db, 'employees', empId));
                            console.log('‚úÖ Staff deleted from Firebase');
                        } else {
                            console.log('üì± Deleting staff in offline mode');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase delete failed, continuing in offline mode:', firebaseError);
                    }

                    // Update local cache - find and remove by ID (clean removal)
                    const keysToDelete = [];
                    Object.keys(employeesCache).forEach(key => {
                        if (employeesCache[key] && employeesCache[key].id === empId) {
                            keysToDelete.push(key);
                        }
                    });
                    
                    keysToDelete.forEach(key => {
                        delete employeesCache[key];
                        console.log('üóëÔ∏è Removed employee key:', key);
                    });
                    
                    hideLoading();
                    loadStaffData();
                    alert('Staff deleted successfully! üóëÔ∏è');
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting staff:', error);
                    alert('Error deleting staff. Please try again.');
                }
            }
        }

        function hideStaffModal() {
            const staffModalElement = document.getElementById('staffModal');
            if (staffModalElement) {
                staffModalElement.classList.add('hidden');
            }
        }

        // Product Management Functions
        function loadProductsData() {
            const productsHtml = productsCache.map(product => `
                <tr class="border-b border-gray-100">
                    <td class="px-4 py-3 text-sm font-semibold">${product.name}</td>
                    <td class="px-4 py-3 text-sm">${product.category}</td>
                    <td class="px-4 py-3 text-sm">‚Çπ${product.price.toLocaleString('en-IN')}</td>
                    <td class="px-4 py-3 text-sm">${product.stock}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs ${product.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${product.status}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editProduct('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">Edit</button>
                        <button onclick="deleteProduct('${product.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            const productsDataElement = document.getElementById('productsData');
            if (productsDataElement) {
                productsDataElement.innerHTML = productsHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No products available</td></tr>';
            }
        }

        function showAddProductModal() {
            const productModalTitleElement = document.getElementById('productModalTitle');
            const productFormElement = document.getElementById('productForm');
            const productIdElement = document.getElementById('productId');
            const productModalElement = document.getElementById('productModal');
            
            if (productModalTitleElement) productModalTitleElement.textContent = 'Add New Product';
            if (productFormElement) productFormElement.reset();
            if (productIdElement) productIdElement.value = '';
            if (productModalElement) productModalElement.classList.remove('hidden');
        }

        function editProduct(productId) {
            const product = productsCache.find(p => p.id === productId);
            
            if (!product) return;
            
            const productModalTitleElement = document.getElementById('productModalTitle');
            const productIdElement = document.getElementById('productId');
            const productNameInputElement = document.getElementById('productNameInput');
            const productCategoryElement = document.getElementById('productCategory');
            const productPriceElement = document.getElementById('productPrice');
            const productStockElement = document.getElementById('productStock');
            const productStatusElement = document.getElementById('productStatus');
            const productModalElement = document.getElementById('productModal');
            
            if (productModalTitleElement) productModalTitleElement.textContent = 'Edit Product';
            if (productIdElement) productIdElement.value = productId;
            if (productNameInputElement) productNameInputElement.value = product.name;
            if (productCategoryElement) productCategoryElement.value = product.category;
            if (productPriceElement) productPriceElement.value = product.price;
            if (productStockElement) productStockElement.value = product.stock;
            if (productStatusElement) productStatusElement.value = product.status;
            if (productModalElement) productModalElement.classList.remove('hidden');
        }

        async function saveProduct() {
            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productNameInput').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const status = document.getElementById('productStatus').value;

            if (!name || !category || !price || !stock) {
                alert('Please fill in all required fields');
                return;
            }

            showLoading();

            try {
                const productData = { 
                    name, 
                    category, 
                    price, 
                    stock, 
                    status,
                    updatedAt: new Date()
                };

                let finalProductId = productId || 'offline_prod_' + Date.now();

                // Try Firebase, continue if it fails
                try {
                    if (window.db && window.firestore) {
                        if (productId) {
                            // Edit existing product
                            const docRef = window.firestore.doc(window.db, 'products', productId);
                            await window.firestore.updateDoc(docRef, productData);
                            console.log('‚úÖ Product updated in Firebase');
                        } else {
                            // Add new product
                            const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'products'), productData);
                            finalProductId = docRef.id;
                            console.log('‚úÖ Product added to Firebase');
                        }
                    } else {
                        console.log('üì± Saving product in offline mode');
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase save failed, continuing in offline mode:', firebaseError);
                }

                // Update local cache
                if (productId) {
                    // Edit existing product
                    const index = productsCache.findIndex(p => p.id === productId);
                    if (index !== -1) {
                        productsCache[index] = { id: productId, ...productData };
                    }
                } else {
                    // Add new product
                    productsCache.push({ id: finalProductId, ...productData });
                }

                // CRITICAL: Save to localStorage immediately
                saveToLocalStorage();

                hideLoading();
                hideProductModal();
                loadProductsData();
                loadDropdownOptions(); // Refresh dropdowns
                alert('Product saved successfully! üéâ');
            } catch (error) {
                hideLoading();
                console.error('Error saving product:', error);
                alert('Error saving product. Please try again.');
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                showLoading();
                
                try {
                    // Try Firebase, continue if it fails
                    try {
                        if (window.db && window.firestore) {
                            await window.firestore.deleteDoc(window.firestore.doc(window.db, 'products', productId));
                            console.log('‚úÖ Product deleted from Firebase');
                        } else {
                            console.log('üì± Deleting product in offline mode');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase delete failed, continuing in offline mode:', firebaseError);
                    }

                    // Update local cache
                    productsCache = productsCache.filter(p => p.id !== productId);
                    
                    hideLoading();
                    loadProductsData();
                    loadDropdownOptions(); // Refresh dropdowns
                    alert('Product deleted successfully! üóëÔ∏è');
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting product:', error);
                    alert('Error deleting product. Please try again.');
                }
            }
        }

        function hideProductModal() {
            const productModalElement = document.getElementById('productModal');
            if (productModalElement) {
                productModalElement.classList.add('hidden');
            }
        }

        // Store Management Functions
        function loadStoresData() {
            const storesHtml = storesCache.map(store => `
                <tr class="border-b border-gray-100">
                    <td class="px-4 py-3 text-sm font-semibold">${store.name}</td>
                    <td class="px-4 py-3 text-sm">${store.location}</td>
                    <td class="px-4 py-3 text-sm">${store.manager}</td>
                    <td class="px-4 py-3 text-sm">${store.phone}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs ${store.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${store.status}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editStore('${store.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">Edit</button>
                        <button onclick="deleteStore('${store.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            const storesDataElement = document.getElementById('storesData');
            if (storesDataElement) {
                storesDataElement.innerHTML = storesHtml || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No stores available</td></tr>';
            }
        }

        function showAddStoreModal() {
            const storeModalTitleElement = document.getElementById('storeModalTitle');
            const storeFormElement = document.getElementById('storeForm');
            const storeIdElement = document.getElementById('storeId');
            const storeModalElement = document.getElementById('storeModal');
            
            if (storeModalTitleElement) storeModalTitleElement.textContent = 'Add New Store';
            if (storeFormElement) storeFormElement.reset();
            if (storeIdElement) storeIdElement.value = '';
            if (storeModalElement) storeModalElement.classList.remove('hidden');
        }

        function editStore(storeId) {
            const store = storesCache.find(s => s.id === storeId);
            
            if (!store) return;
            
            const storeModalTitleElement = document.getElementById('storeModalTitle');
            const storeIdElement = document.getElementById('storeId');
            const storeNameInputElement = document.getElementById('storeNameInput');
            const storeLocationElement = document.getElementById('storeLocation');
            const storeManagerElement = document.getElementById('storeManager');
            const storePhoneElement = document.getElementById('storePhone');
            const storeStatusElement = document.getElementById('storeStatus');
            const storeModalElement = document.getElementById('storeModal');
            
            if (storeModalTitleElement) storeModalTitleElement.textContent = 'Edit Store';
            if (storeIdElement) storeIdElement.value = storeId;
            if (storeNameInputElement) storeNameInputElement.value = store.name;
            if (storeLocationElement) storeLocationElement.value = store.location;
            if (storeManagerElement) storeManagerElement.value = store.manager;
            if (storePhoneElement) storePhoneElement.value = store.phone;
            if (storeStatusElement) storeStatusElement.value = store.status;
            if (storeModalElement) storeModalElement.classList.remove('hidden');
        }

        async function saveStore() {
            const storeId = document.getElementById('storeId').value;
            const name = document.getElementById('storeNameInput').value.trim();
            const location = document.getElementById('storeLocation').value.trim();
            const manager = document.getElementById('storeManager').value.trim();
            const phone = document.getElementById('storePhone').value.trim();
            const status = document.getElementById('storeStatus').value;

            if (!name || !location || !manager || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            showLoading();

            try {
                const storeData = { 
                    name, 
                    location, 
                    manager, 
                    phone, 
                    status,
                    updatedAt: new Date()
                };

                let finalStoreId = storeId || 'offline_store_' + Date.now();

                // Try Firebase, continue if it fails
                try {
                    if (window.db && window.firestore) {
                        if (storeId) {
                            // Edit existing store
                            const docRef = window.firestore.doc(window.db, 'stores', storeId);
                            await window.firestore.updateDoc(docRef, storeData);
                            console.log('‚úÖ Store updated in Firebase');
                        } else {
                            // Add new store
                            const docRef = await window.firestore.addDoc(window.firestore.collection(window.db, 'stores'), storeData);
                            finalStoreId = docRef.id;
                            console.log('‚úÖ Store added to Firebase');
                        }
                    } else {
                        console.log('üì± Saving store in offline mode');
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase save failed, continuing in offline mode:', firebaseError);
                }

                // Update local cache
                if (storeId) {
                    // Edit existing store
                    const index = storesCache.findIndex(s => s.id === storeId);
                    if (index !== -1) {
                        storesCache[index] = { id: storeId, ...storeData };
                    }
                } else {
                    // Add new store
                    storesCache.push({ id: finalStoreId, ...storeData });
                }

                // CRITICAL: Save to localStorage immediately
                saveToLocalStorage();

                hideLoading();
                hideStoreModal();
                loadStoresData();
                loadDropdownOptions(); // Refresh dropdowns
                alert('Store saved successfully! üè™');
            } catch (error) {
                hideLoading();
                console.error('Error saving store:', error);
                alert('Error saving store. Please try again.');
            }
        }

        async function deleteStore(storeId) {
            if (confirm('Are you sure you want to delete this store?')) {
                showLoading();
                
                try {
                    // Try Firebase, continue if it fails
                    try {
                        if (window.db && window.firestore) {
                            await window.firestore.deleteDoc(window.firestore.doc(window.db, 'stores', storeId));
                            console.log('‚úÖ Store deleted from Firebase');
                        } else {
                            console.log('üì± Deleting store in offline mode');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase delete failed, continuing in offline mode:', firebaseError);
                    }

                    // Update local cache
                    storesCache = storesCache.filter(s => s.id !== storeId);
                    
                    hideLoading();
                    loadStoresData();
                    loadDropdownOptions(); // Refresh dropdowns
                    alert('Store deleted successfully! üóëÔ∏è');
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting store:', error);
                    alert('Error deleting store. Please try again.');
                }
            }
        }

        function hideStoreModal() {
            const storeModalElement = document.getElementById('storeModal');
            if (storeModalElement) {
                storeModalElement.classList.add('hidden');
            }
        }

        // Sales Edit/Delete Functions
        function editSale(saleId) {
            const sale = salesCache.find(s => s.id === saleId);
            
            if (!sale) return;
            
            currentEditingSale = saleId;
            
            const editSaleIdElement = document.getElementById('editSaleId');
            const editSaleDateElement = document.getElementById('editSaleDate');
            const editSaleStoreElement = document.getElementById('editSaleStore');
            const editSaleProductElement = document.getElementById('editSaleProduct');
            const editSaleQuantityElement = document.getElementById('editSaleQuantity');
            const editSalePriceElement = document.getElementById('editSalePrice');
            const editSaleModalElement = document.getElementById('editSaleModal');
            
            if (editSaleIdElement) editSaleIdElement.value = saleId;
            if (editSaleDateElement) editSaleDateElement.value = sale.date;
            if (editSaleStoreElement) editSaleStoreElement.value = sale.storeName;
            if (editSaleProductElement) editSaleProductElement.value = sale.productName;
            if (editSaleQuantityElement) editSaleQuantityElement.value = sale.quantity;
            if (editSalePriceElement) editSalePriceElement.value = sale.price;
            if (editSaleModalElement) editSaleModalElement.classList.remove('hidden');
        }

        async function updateSale() {
            const saleId = document.getElementById('editSaleId').value;
            const date = document.getElementById('editSaleDate').value;
            const storeName = document.getElementById('editSaleStore').value;
            const productName = document.getElementById('editSaleProduct').value;
            const quantity = parseInt(document.getElementById('editSaleQuantity').value);
            const price = parseFloat(document.getElementById('editSalePrice').value) || 0;

            if (!date || !storeName || !productName || !quantity) {
                alert('Please fill in all required fields');
                return;
            }

            showLoading();

            try {
                const updatedData = {
                    date: date,
                    storeName: storeName,
                    productName: productName,
                    quantity: quantity,
                    price: price,
                    total: quantity * price,
                    updatedAt: new Date()
                };

                // Try Firebase, continue if it fails
                try {
                    if (window.db && window.firestore) {
                        await window.firestore.updateDoc(window.firestore.doc(window.db, 'sales', saleId), updatedData);
                        console.log('‚úÖ Sale updated in Firebase');
                    } else {
                        console.log('üì± Updating sale in offline mode');
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase update failed, continuing in offline mode:', firebaseError);
                }
                
                // Update local cache
                const index = salesCache.findIndex(s => s.id === saleId);
                if (index !== -1) {
                    salesCache[index] = { ...salesCache[index], ...updatedData };
                }

                hideLoading();
                hideEditSaleModal();
                
                if (isAdmin) {
                    loadAllSalesData();
                    await loadAdminData();
                } else {
                    loadEmployeeSalesData();
                }
                
                alert('Sale updated successfully! ‚úÖ');
            } catch (error) {
                hideLoading();
                console.error('Error updating sale:', error);
                alert('Error updating sale. Please try again.');
            }
        }

        async function deleteSale(saleId) {
            if (confirm('Are you sure you want to delete this sale?')) {
                showLoading();
                
                try {
                    // Try Firebase, continue if it fails
                    try {
                        if (window.db && window.firestore) {
                            await window.firestore.deleteDoc(window.firestore.doc(window.db, 'sales', saleId));
                            console.log('‚úÖ Sale deleted from Firebase');
                        } else {
                            console.log('üì± Deleting sale in offline mode');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase delete failed, continuing in offline mode:', firebaseError);
                    }

                    // Update local cache
                    salesCache = salesCache.filter(s => s.id !== saleId);
                    
                    hideLoading();
                    
                    if (isAdmin) {
                        loadAllSalesData();
                        await loadAdminData();
                    } else {
                        loadEmployeeSalesData();
                    }
                    
                    alert('Sale deleted successfully! üóëÔ∏è');
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting sale:', error);
                    alert('Error deleting sale. Please try again.');
                }
            }
        }

        function hideEditSaleModal() {
            const editSaleModalElement = document.getElementById('editSaleModal');
            if (editSaleModalElement) {
                editSaleModalElement.classList.add('hidden');
            }
            currentEditingSale = null;
        }

        function filterByDate() {
            const filterDate = document.getElementById('filterDate').value;
            if (!filterDate) {
                alert('Please select a date to filter');
                return;
            }
            
            const filteredSales = salesCache.filter(sale => sale.date === filterDate);
            loadAllSalesData(filteredSales);
        }

        function clearFilter() {
            const filterDateElement = document.getElementById('filterDate');
            if (filterDateElement) {
                filterDateElement.value = '';
            }
            loadAllSalesData();
        }

        function downloadSalesData() {
            const employeeSales = salesCache.filter(sale => sale.employeeId === currentUser);
            
            if (employeeSales.length === 0) {
                alert('No sales data to download');
                return;
            }
            
            // Create CSV content with BOM for proper Excel opening
            const csvContent = '\uFEFF' + [
                ['Date', 'Store', 'Product', 'Quantity', 'Price', 'Total'],
                ...employeeSales.map(sale => [
                    sale.date,
                    `"${sale.storeName}"`,
                    `"${sale.productName}"`,
                    sale.quantity,
                    sale.price,
                    sale.total
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_Sales_${currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Sales data downloaded successfully! üì•');
        }

        function downloadDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesCache.filter(sale => sale.date === today);
            
            if (todaySales.length === 0) {
                alert('No sales data for today');
                return;
            }
            
            // Create CSV content with BOM
            const csvContent = '\uFEFF' + [
                ['Date', 'Employee ID', 'Employee Name', 'Store', 'Product', 'Quantity', 'Price', 'Total'],
                ...todaySales.map(sale => [
                    sale.date,
                    sale.employeeId,
                    `"${sale.employeeName}"`,
                    `"${sale.storeName}"`,
                    `"${sale.productName}"`,
                    sale.quantity,
                    sale.price,
                    sale.total
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_Daily_Report_${today}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Daily report downloaded successfully! üìä');
        }

        // Report Management Functions
        function initializeReports() {
            const reportDateElement = document.getElementById('reportDate');
            if (reportDateElement) {
                reportDateElement.value = new Date().toISOString().split('T')[0];
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            let reportData = [];
            let title = '';
            
            switch(reportType) {
                case 'daily':
                    reportData = generateDailyReport(salesCache, reportDate);
                    title = `Daily Sales Report - ${reportDate}`;
                    break;
                case 'monthly':
                    reportData = generateMonthlyReport(salesCache, reportDate);
                    title = `Monthly Sales Report - ${reportDate.substring(0, 7)}`;
                    break;
                case 'product':
                    reportData = generateProductReport(salesCache, reportDate);
                    title = 'Product-wise Sales Report';
                    break;
                case 'staff':
                    reportData = generateStaffReport(salesCache, reportDate);
                    title = 'Staff-wise Sales Report';
                    break;
                case 'store':
                    reportData = generateStoreReport(salesCache, reportDate);
                    title = 'Store-wise Sales Report';
                    break;
            }
            
            currentReportData = reportData;
            displayReport(reportData, title, reportType);
            
            // Update download button text with report names
            const reportTypeNames = {
                'daily': 'Daily Report',
                'monthly': 'Monthly Report', 
                'product': 'Product Report',
                'staff': 'Staff Report',
                'store': 'Store Report'
            };
            
            const reportName = reportTypeNames[reportType] || 'Report';
            const pdfDownloadBtnElement = document.getElementById('pdfDownloadBtn');
            const excelDownloadBtnElement = document.getElementById('excelDownloadBtn');
            
            if (pdfDownloadBtnElement) {
                pdfDownloadBtnElement.innerHTML = `üìÑ Download ${reportName} PDF`;
            }
            if (excelDownloadBtnElement) {
                excelDownloadBtnElement.innerHTML = `üìä Download ${reportName} Excel`;
            }
        }

        function generateDailyReport(sales, date) {
            return sales.filter(sale => sale.date === date);
        }

        function generateMonthlyReport(sales, date) {
            const month = date.substring(0, 7); // YYYY-MM
            return sales.filter(sale => sale.date.startsWith(month));
        }

        function generateProductReport(sales, date) {
            const productStats = {};
            const filteredSales = date ? sales.filter(sale => sale.date === date) : sales;
            
            filteredSales.forEach(sale => {
                if (!productStats[sale.productName]) {
                    productStats[sale.productName] = {
                        productName: sale.productName,
                        totalQuantity: 0,
                        totalRevenue: 0,
                        orderCount: 0
                    };
                }
                productStats[sale.productName].totalQuantity += sale.quantity;
                productStats[sale.productName].totalRevenue += sale.total;
                productStats[sale.productName].orderCount += 1;
            });
            
            return Object.values(productStats);
        }

        function generateStaffReport(sales, date) {
            const staffStats = {};
            const filteredSales = date ? sales.filter(sale => sale.date === date) : sales;
            
            filteredSales.forEach(sale => {
                if (!staffStats[sale.employeeId]) {
                    staffStats[sale.employeeId] = {
                        employeeId: sale.employeeId,
                        employeeName: sale.employeeName,
                        totalQuantity: 0,
                        totalRevenue: 0,
                        orderCount: 0
                    };
                }
                staffStats[sale.employeeId].totalQuantity += sale.quantity;
                staffStats[sale.employeeId].totalRevenue += sale.total;
                staffStats[sale.employeeId].orderCount += 1;
            });
            
            return Object.values(staffStats);
        }

        function generateStoreReport(sales, date) {
            const storeStats = {};
            const filteredSales = date ? sales.filter(sale => sale.date === date) : sales;
            
            filteredSales.forEach(sale => {
                if (!storeStats[sale.storeName]) {
                    storeStats[sale.storeName] = {
                        storeName: sale.storeName,
                        totalQuantity: 0,
                        totalRevenue: 0,
                        orderCount: 0
                    };
                }
                storeStats[sale.storeName].totalQuantity += sale.quantity;
                storeStats[sale.storeName].totalRevenue += sale.total;
                storeStats[sale.storeName].orderCount += 1;
            });
            
            return Object.values(storeStats);
        }

        function displayReport(data, title, type) {
            const reportTitleElement = document.getElementById('reportTitle');
            const reportSummaryElement = document.getElementById('reportSummary');
            const reportContentElement = document.getElementById('reportContent');
            
            if (reportTitleElement) {
                reportTitleElement.textContent = title;
            }
            
            let totalQty = 0;
            let totalRevenue = 0;
            let totalOrders = data.length;
            
            if (type === 'daily' || type === 'monthly') {
                data.forEach(sale => {
                    totalQty += sale.quantity;
                    totalRevenue += sale.total;
                });
                
                const reportHtml = `
                    <table class="w-full mobile-table">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Date</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Employee</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Store</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Product</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Qty</th>
                                <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(sale => `
                                <tr class="border-b border-gray-100">
                                    <td class="px-2 py-2 text-xs">${sale.date}</td>
                                    <td class="px-2 py-2 text-xs">${sale.employeeName}</td>
                                    <td class="px-2 py-2 text-xs">${sale.storeName}</td>
                                    <td class="px-2 py-2 text-xs">${sale.productName}</td>
                                    <td class="px-2 py-2 text-xs font-semibold">${sale.quantity}</td>
                                    <td class="px-2 py-2 text-xs font-semibold text-green-600">‚Çπ${sale.total}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                if (reportContentElement) {
                    reportContentElement.innerHTML = reportHtml;
                }
            } else {
                // For aggregated reports (product, staff, store)
                data.forEach(item => {
                    totalQty += item.totalQuantity;
                    totalRevenue += item.totalRevenue;
                });
                
                let reportHtml = '';
                if (type === 'product') {
                    reportHtml = `
                        <table class="w-full mobile-table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Product</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Qty Sold</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Revenue</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Orders</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr class="border-b border-gray-100">
                                        <td class="px-2 py-2 text-xs font-semibold">${item.productName}</td>
                                        <td class="px-2 py-2 text-xs">${item.totalQuantity}</td>
                                        <td class="px-2 py-2 text-xs text-green-600">‚Çπ${item.totalRevenue}</td>
                                        <td class="px-2 py-2 text-xs">${item.orderCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'staff') {
                    reportHtml = `
                        <table class="w-full mobile-table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Employee</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Qty Sold</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Revenue</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Orders</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr class="border-b border-gray-100">
                                        <td class="px-2 py-2 text-xs font-semibold">${item.employeeName}</td>
                                        <td class="px-2 py-2 text-xs">${item.totalQuantity}</td>
                                        <td class="px-2 py-2 text-xs text-green-600">‚Çπ${item.totalRevenue}</td>
                                        <td class="px-2 py-2 text-xs">${item.orderCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'store') {
                    reportHtml = `
                        <table class="w-full mobile-table">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Store</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Qty Sold</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Revenue</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">Orders</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr class="border-b border-gray-100">
                                        <td class="px-2 py-2 text-xs font-semibold">${item.storeName}</td>
                                        <td class="px-2 py-2 text-xs">${item.totalQuantity}</td>
                                        <td class="px-2 py-2 text-xs text-green-600">‚Çπ${item.totalRevenue}</td>
                                        <td class="px-2 py-2 text-xs">${item.orderCount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                if (reportContentElement) {
                    reportContentElement.innerHTML = reportHtml;
                }
            }
            
            if (reportSummaryElement) {
                reportSummaryElement.textContent = 
                    `Total: ${totalQty} units ‚Ä¢ ‚Çπ${totalRevenue.toLocaleString('en-IN')} ‚Ä¢ ${totalOrders} orders`;
            }
        }

        function downloadReportPDF() {
            if (currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }
            
            // Create a simple HTML content for PDF
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const reportTitleElement = document.getElementById('reportTitle');
            const reportSummaryElement = document.getElementById('reportSummary');
            const reportContentElement = document.getElementById('reportContent');
            
            const title = reportTitleElement ? reportTitleElement.textContent : 'Report';
            const summary = reportSummaryElement ? reportSummaryElement.textContent : '';
            const content = reportContentElement ? reportContentElement.innerHTML : '';
            
            let htmlContent = `
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary { background-color: #f9f9f9; padding: 10px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>üå∏ Eden Perfume - ${title}</h1>
                    <div class="summary">
                        <strong>Report Summary:</strong> ${summary}
                    </div>
                    ${content}
                </body>
                </html>
            `;
            
            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_${reportType}_Report_${reportDate}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Report downloaded as HTML file (can be opened and printed as PDF)');
        }

        function downloadReportExcel() {
            if (currentReportData.length === 0) {
                alert('Please generate a report first');
                return;
            }
            
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            let csvContent = '';
            let headers = [];
            let rows = [];
            
            if (reportType === 'daily' || reportType === 'monthly') {
                headers = ['Date', 'Employee ID', 'Employee Name', 'Store', 'Product', 'Quantity', 'Price', 'Total'];
                rows = currentReportData.map(sale => [
                    sale.date,
                    sale.employeeId,
                    `"${sale.employeeName}"`,
                    `"${sale.storeName}"`,
                    `"${sale.productName}"`,
                    sale.quantity,
                    sale.price,
                    sale.total
                ]);
            } else if (reportType === 'product') {
                headers = ['Product Name', 'Total Quantity', 'Total Revenue', 'Order Count'];
                rows = currentReportData.map(item => [
                    `"${item.productName}"`,
                    item.totalQuantity,
                    item.totalRevenue,
                    item.orderCount
                ]);
            } else if (reportType === 'staff') {
                headers = ['Employee ID', 'Employee Name', 'Total Quantity', 'Total Revenue', 'Order Count'];
                rows = currentReportData.map(item => [
                    item.employeeId,
                    `"${item.employeeName}"`,
                    item.totalQuantity,
                    item.totalRevenue,
                    item.orderCount
                ]);
            } else if (reportType === 'store') {
                headers = ['Store Name', 'Total Quantity', 'Total Revenue', 'Order Count'];
                rows = currentReportData.map(item => [
                    `"${item.storeName}"`,
                    item.totalQuantity,
                    item.totalRevenue,
                    item.orderCount
                ]);
            }
            
            csvContent = '\uFEFF' + [headers, ...rows].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_${reportType}_Report_${reportDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Report downloaded successfully! üìä');
        }

        function downloadMasterData() {
            // Create comprehensive Excel-like CSV with multiple sheets data
            let masterContent = '\uFEFF';
            
            // Sales Data
            masterContent += 'SALES DATA\n';
            masterContent += 'Date,Employee ID,Employee Name,Store,Product,Quantity,Price,Total\n';
            salesCache.forEach(sale => {
                masterContent += `${sale.date},${sale.employeeId},"${sale.employeeName}","${sale.storeName}","${sale.productName}",${sale.quantity},${sale.price},${sale.total}\n`;
            });
            
            masterContent += '\n\nEMPLOYEE DATA\n';
            masterContent += 'Employee ID,Name,Phone,Email,Status\n';
            Object.keys(employeesCache).forEach(empId => {
                const emp = employeesCache[empId];
                masterContent += `${empId},"${emp.name}",${emp.phone},"${emp.email}",${emp.status}\n`;
            });
            
            masterContent += '\n\nPRODUCT DATA\n';
            masterContent += 'Product Name,Category,Price,Stock,Status\n';
            productsCache.forEach(product => {
                masterContent += `"${product.name}",${product.category},${product.price},${product.stock},${product.status}\n`;
            });
            
            masterContent += '\n\nSTORE DATA\n';
            masterContent += 'Store Name,Location,Manager,Phone,Status\n';
            storesCache.forEach(store => {
                masterContent += `"${store.name}","${store.location}","${store.manager}",${store.phone},${store.status}\n`;
            });
            
            const blob = new Blob([masterContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_Master_Data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Master data downloaded successfully! üìä');
        }

        // Firebase Data Viewer Functions
        let currentFirebaseCollection = '';
        let currentFirebaseData = null;

        async function viewFirebaseData(collection) {
            currentFirebaseCollection = collection;
            
            const firebaseDataModalElement = document.getElementById('firebaseDataModal');
            const firebaseDataTitleElement = document.getElementById('firebaseDataTitle');
            const firebaseDataInfoElement = document.getElementById('firebaseDataInfo');
            const firebaseDataContentElement = document.getElementById('firebaseDataContent');
            
            if (firebaseDataTitleElement) {
                firebaseDataTitleElement.textContent = `üî• Firebase ${collection.charAt(0).toUpperCase() + collection.slice(1)} Collection`;
            }
            
            if (firebaseDataInfoElement) {
                firebaseDataInfoElement.textContent = 'Loading data from Firebase...';
            }
            
            if (firebaseDataContentElement) {
                firebaseDataContentElement.textContent = 'Loading...';
            }
            
            if (firebaseDataModalElement) {
                firebaseDataModalElement.classList.remove('hidden');
            }
            
            await loadFirebaseCollectionData(collection);
        }

        async function loadFirebaseCollectionData(collection) {
            const firebaseDataInfoElement = document.getElementById('firebaseDataInfo');
            const firebaseDataContentElement = document.getElementById('firebaseDataContent');
            
            try {
                if (!window.db || !window.firestore) {
                    throw new Error('Firebase not initialized');
                }
                
                console.log(`üî• Loading ${collection} collection from Firebase...`);
                
                const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, collection));
                const data = [];
                
                snapshot.forEach((doc) => {
                    data.push({
                        id: doc.id,
                        ...doc.data(),
                        // Convert Firestore timestamps to readable format
                        _metadata: {
                            docId: doc.id,
                            exists: doc.exists(),
                            createTime: doc.createTime ? doc.createTime.toDate().toISOString() : 'N/A',
                            updateTime: doc.updateTime ? doc.updateTime.toDate().toISOString() : 'N/A'
                        }
                    });
                });
                
                currentFirebaseData = data;
                
                // Display formatted data
                const formattedData = JSON.stringify(data, null, 2);
                
                if (firebaseDataContentElement) {
                    firebaseDataContentElement.textContent = formattedData;
                }
                
                if (firebaseDataInfoElement) {
                    firebaseDataInfoElement.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <span class="text-green-600">‚úÖ Connected to Firebase</span>
                            <span class="text-blue-600">üìä ${data.length} documents found</span>
                            <span class="text-gray-600">üïí Last updated: ${new Date().toLocaleTimeString()}</span>
                        </div>
                    `;
                }
                
                console.log(`‚úÖ Loaded ${data.length} documents from ${collection} collection`);
                
            } catch (error) {
                console.error(`‚ùå Error loading ${collection} collection:`, error);
                
                // Handle specific Firebase permission errors
                if (error.code === 'permission-denied') {
                    const permissionFix = `
üîß SECURE FIREBASE RULES NEEDED:

Go to Firebase Console ‚Üí Firestore Database ‚Üí Rules and update to:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only allow access from your domain/app
    match /{document=**} {
      allow read, write: if request.auth != null 
        || resource == null 
        || request.time < timestamp.date(2025, 2, 1);
    }
    
    // More secure alternative - restrict by collection:
    // match /employees/{document} {
    //   allow read, write: if request.auth != null;
    // }
    // match /sales/{document} {
    //   allow read, write: if request.auth != null;
    // }
    // match /products/{document} {
    //   allow read, write: if request.auth != null;
    // }
    // match /stores/{document} {
    //   allow read, write: if request.auth != null;
    // }
  }
}

üîí SECURITY RECOMMENDATIONS:
1. Enable Firebase Authentication
2. Add user-based access controls
3. Use environment variables for API keys
4. Implement proper validation rules

Current cached data from localStorage:
${collection}: ${getCachedDataCount(collection)} items
                    `;
                    
                    if (firebaseDataContentElement) {
                        firebaseDataContentElement.textContent = permissionFix;
                    }
                    
                    if (firebaseDataInfoElement) {
                        firebaseDataInfoElement.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <span class="text-red-600">üîí Permission Denied</span>
                                <span class="text-yellow-600">üì± Using Local Cache</span>
                                <span class="text-blue-600">üìä ${getCachedDataCount(collection)} cached items</span>
                            </div>
                        `;
                    }
                    
                    // Show cached data instead
                    displayCachedData(collection);
                    
                } else {
                    if (firebaseDataContentElement) {
                        firebaseDataContentElement.textContent = `Error loading data: ${error.message}\n\nPossible causes:\n1. Firebase not initialized\n2. Collection doesn't exist\n3. Permission denied\n4. Network error\n\nCheck console for more details.`;
                    }
                    
                    if (firebaseDataInfoElement) {
                        firebaseDataInfoElement.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <span class="text-red-600">‚ùå Firebase Error</span>
                                <span class="text-gray-600">Collection: ${collection}</span>
                                <span class="text-gray-600">Error: ${error.message}</span>
                            </div>
                        `;
                    }
                }
            }
        }

        function getCachedDataCount(collection) {
            switch(collection) {
                case 'employees': return Object.keys(employeesCache).length;
                case 'products': return productsCache.length;
                case 'stores': return storesCache.length;
                case 'sales': return salesCache.length;
                default: return 0;
            }
        }

        function displayCachedData(collection) {
            const firebaseDataContentElement = document.getElementById('firebaseDataContent');
            let cachedData = null;
            
            switch(collection) {
                case 'employees':
                    cachedData = Object.values(employeesCache);
                    break;
                case 'products':
                    cachedData = productsCache;
                    break;
                case 'stores':
                    cachedData = storesCache;
                    break;
                case 'sales':
                    cachedData = salesCache.slice(0, 50); // Show first 50 sales
                    break;
            }
            
            if (cachedData && firebaseDataContentElement) {
                const formattedData = JSON.stringify(cachedData, null, 2);
                firebaseDataContentElement.textContent = `üì± CACHED DATA (Local Storage):\n\n${formattedData}`;
                currentFirebaseData = cachedData;
            }
        }

        function refreshFirebaseData() {
            if (currentFirebaseCollection) {
                loadFirebaseCollectionData(currentFirebaseCollection);
            }
        }

        function downloadFirebaseData() {
            if (!currentFirebaseData) {
                alert('No data to download');
                return;
            }
            
            const jsonContent = JSON.stringify(currentFirebaseData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Firebase_${currentFirebaseCollection}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert(`Firebase ${currentFirebaseCollection} data downloaded! üì•`);
        }

        function hideFirebaseDataModal() {
            const firebaseDataModalElement = document.getElementById('firebaseDataModal');
            if (firebaseDataModalElement) {
                firebaseDataModalElement.classList.add('hidden');
            }
            currentFirebaseCollection = '';
            currentFirebaseData = null;
        }

        // Automatic Attendance Function
        async function autoMarkAttendance(employeeId, saleDate) {
            try {
                const employee = employeesCache[employeeId];
                if (!employee) {
                    console.warn('Employee not found for auto attendance:', employeeId);
                    return;
                }

                // Check if attendance already exists for this date
                let existingAttendance = attendanceCache.find(att => 
                    att.employeeId === employeeId && att.date === saleDate
                );

                if (!existingAttendance) {
                    // Create new attendance record
                    const newAttendance = {
                        id: 'att_auto_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        employeeId: employeeId,
                        employeeName: employee.name,
                        date: saleDate,
                        status: 'Present',
                        checkIn: '09:00',
                        checkOut: '18:00',
                        hours: 9,
                        autoMarked: true,
                        timestamp: new Date().toISOString()
                    };

                    attendanceCache.push(newAttendance);
                    console.log('‚úÖ Auto-marked attendance as Present for:', employee.name, 'on', saleDate);

                    // Try to save to Firebase
                    try {
                        if (window.db && window.firestore) {
                            await window.firestore.addDoc(window.firestore.collection(window.db, 'attendance'), newAttendance);
                            console.log('‚úÖ Auto attendance saved to Firebase');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase attendance save failed:', firebaseError);
                    }

                    // Save to localStorage
                    saveToLocalStorage();
                } else if (existingAttendance.status === 'Absent') {
                    // Update existing absent record to present
                    existingAttendance.status = 'Present';
                    existingAttendance.checkIn = existingAttendance.checkIn || '09:00';
                    existingAttendance.checkOut = existingAttendance.checkOut || '18:00';
                    existingAttendance.hours = existingAttendance.hours || 9;
                    existingAttendance.autoMarked = true;
                    existingAttendance.updatedAt = new Date().toISOString();

                    console.log('‚úÖ Updated attendance from Absent to Present for:', employee.name, 'on', saleDate);

                    // Try to update in Firebase
                    try {
                        if (window.db && window.firestore && existingAttendance.id) {
                            await window.firestore.updateDoc(
                                window.firestore.doc(window.db, 'attendance', existingAttendance.id), 
                                {
                                    status: 'Present',
                                    checkIn: existingAttendance.checkIn,
                                    checkOut: existingAttendance.checkOut,
                                    hours: existingAttendance.hours,
                                    autoMarked: true,
                                    updatedAt: new Date().toISOString()
                                }
                            );
                            console.log('‚úÖ Auto attendance update saved to Firebase');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase attendance update failed:', firebaseError);
                    }

                    // Save to localStorage
                    saveToLocalStorage();
                } else {
                    console.log('üìã Attendance already marked as Present for:', employee.name, 'on', saleDate);
                }
            } catch (error) {
                console.error('‚ùå Error in auto attendance marking:', error);
            }
        }

        // Daily Auto-Attendance Check (Mark absent for employees with no sales)
        function checkDailyAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const activeEmployees = Object.values(employeesCache).filter(emp => emp.status === 'Active');
            const todaySales = salesCache.filter(sale => sale.date === today);
            const employeesWithSales = new Set(todaySales.map(sale => sale.username));

            activeEmployees.forEach(emp => {
                const existingAttendance = attendanceCache.find(att => 
                    att.employeeId === emp.username && att.date === today
                );

                if (!existingAttendance && !employeesWithSales.has(emp.username)) {
                    // Mark as absent if no sales and no attendance record
                    const absentRecord = {
                        id: 'att_absent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        employeeId: emp.username,
                        employeeName: emp.name,
                        date: today,
                        status: 'Absent',
                        checkIn: '',
                        checkOut: '',
                        hours: 0,
                        autoMarked: true,
                        timestamp: new Date().toISOString()
                    };

                    attendanceCache.push(absentRecord);
                    console.log('üìã Auto-marked as Absent (no sales):', emp.name);
                }
            });

            saveToLocalStorage();
        }

        // Run daily attendance check every hour
        setInterval(checkDailyAttendance, 3600000); // 1 hour

        // Attendance Management Functions
        function loadAttendanceData() {
            const today = new Date().toISOString().split('T')[0];
            const attendanceDateElement = document.getElementById('attendanceDate');
            if (attendanceDateElement) {
                attendanceDateElement.value = today;
            }
            
            // Generate attendance records for today for all active employees
            const activeEmployees = Object.values(employeesCache).filter(emp => emp.status === 'Active');
            const todayAttendance = attendanceCache.filter(att => att.date === today);
            
            const attendanceHtml = activeEmployees.map(emp => {
                const existingAttendance = todayAttendance.find(att => att.employeeId === emp.username);
                const attendance = existingAttendance || {
                    employeeId: emp.username,
                    employeeName: emp.name,
                    date: today,
                    status: 'Absent',
                    checkIn: '',
                    checkOut: '',
                    hours: 0
                };
                
                const autoMarkedIcon = attendance.autoMarked ? 'ü§ñ' : '';
                const statusColor = attendance.status === 'Present' ? 'bg-green-100 text-green-800' : 
                                  attendance.status === 'Half Day' ? 'bg-yellow-100 text-yellow-800' :
                                  attendance.status === 'Late' ? 'bg-orange-100 text-orange-800' : 'bg-red-100 text-red-800';
                
                return `
                    <tr class="border-b border-gray-100">
                        <td class="px-4 py-3 text-sm font-semibold">${emp.name}</td>
                        <td class="px-4 py-3 text-sm">${today}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center space-x-1">
                                <select onchange="updateAttendanceStatus('${emp.username}', this.value)" class="px-2 py-1 border rounded text-xs ${statusColor}">
                                    <option value="Present" ${attendance.status === 'Present' ? 'selected' : ''}>Present</option>
                                    <option value="Absent" ${attendance.status === 'Absent' ? 'selected' : ''}>Absent</option>
                                    <option value="Half Day" ${attendance.status === 'Half Day' ? 'selected' : ''}>Half Day</option>
                                    <option value="Late" ${attendance.status === 'Late' ? 'selected' : ''}>Late</option>
                                </select>
                                ${autoMarkedIcon ? `<span title="Auto-marked by sales entry">${autoMarkedIcon}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <input type="time" value="${attendance.checkIn}" onchange="updateCheckTime('${emp.username}', 'checkIn', this.value)" class="px-2 py-1 border rounded text-xs">
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <input type="time" value="${attendance.checkOut}" onchange="updateCheckTime('${emp.username}', 'checkOut', this.value)" class="px-2 py-1 border rounded text-xs">
                        </td>
                        <td class="px-4 py-3 text-sm font-semibold">${attendance.hours}h</td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="saveAttendance('${emp.username}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs">Save</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const attendanceDataElement = document.getElementById('attendanceData');
            if (attendanceDataElement) {
                attendanceDataElement.innerHTML = attendanceHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No employees found</td></tr>';
            }
        }

        function updateAttendanceStatus(employeeId, status) {
            const today = new Date().toISOString().split('T')[0];
            let attendance = attendanceCache.find(att => att.employeeId === employeeId && att.date === today);
            
            if (!attendance) {
                const employee = Object.values(employeesCache).find(emp => emp.username === employeeId);
                attendance = {
                    id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    employeeId: employeeId,
                    employeeName: employee ? employee.name : 'Unknown',
                    date: today,
                    status: status,
                    checkIn: '',
                    checkOut: '',
                    hours: 0
                };
                attendanceCache.push(attendance);
            } else {
                attendance.status = status;
            }
            
            // Auto-set times based on status
            if (status === 'Present' && !attendance.checkIn) {
                attendance.checkIn = '09:00';
                attendance.checkOut = '18:00';
                attendance.hours = 9;
            } else if (status === 'Half Day') {
                attendance.checkIn = '09:00';
                attendance.checkOut = '13:00';
                attendance.hours = 4;
            } else if (status === 'Late') {
                attendance.checkIn = '10:00';
                attendance.checkOut = '18:00';
                attendance.hours = 8;
            } else if (status === 'Absent') {
                attendance.checkIn = '';
                attendance.checkOut = '';
                attendance.hours = 0;
            }
            
            saveToLocalStorage();
            loadAttendanceData(); // Refresh display
        }

        function updateCheckTime(employeeId, timeType, value) {
            const today = new Date().toISOString().split('T')[0];
            let attendance = attendanceCache.find(att => att.employeeId === employeeId && att.date === today);
            
            if (!attendance) {
                const employee = Object.values(employeesCache).find(emp => emp.username === employeeId);
                attendance = {
                    id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    employeeId: employeeId,
                    employeeName: employee ? employee.name : 'Unknown',
                    date: today,
                    status: 'Present',
                    checkIn: '',
                    checkOut: '',
                    hours: 0
                };
                attendanceCache.push(attendance);
            }
            
            attendance[timeType] = value;
            
            // Calculate hours if both times are set
            if (attendance.checkIn && attendance.checkOut) {
                const checkIn = new Date(`2000-01-01T${attendance.checkIn}:00`);
                const checkOut = new Date(`2000-01-01T${attendance.checkOut}:00`);
                const diffMs = checkOut - checkIn;
                attendance.hours = Math.max(0, Math.round(diffMs / (1000 * 60 * 60) * 10) / 10);
            }
            
            saveToLocalStorage();
        }

        async function saveAttendance(employeeId) {
            const today = new Date().toISOString().split('T')[0];
            const attendance = attendanceCache.find(att => att.employeeId === employeeId && att.date === today);
            
            if (!attendance) {
                alert('No attendance data to save');
                return;
            }
            
            try {
                // Try Firebase, continue if it fails
                try {
                    if (window.db && window.firestore) {
                        await window.firestore.addDoc(window.firestore.collection(window.db, 'attendance'), attendance);
                        console.log('‚úÖ Attendance saved to Firebase');
                    }
                } catch (firebaseError) {
                    console.warn('‚ö†Ô∏è Firebase save failed, continuing in offline mode:', firebaseError);
                }
                
                saveToLocalStorage();
                alert(`Attendance saved for ${attendance.employeeName}! ‚úÖ`);
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert('Error saving attendance. Please try again.');
            }
        }

        function markAllPresent() {
            const today = new Date().toISOString().split('T')[0];
            const activeEmployees = Object.values(employeesCache).filter(emp => emp.status === 'Active');
            
            activeEmployees.forEach(emp => {
                updateAttendanceStatus(emp.username, 'Present');
            });
            
            alert(`Marked all ${activeEmployees.length} employees as present! ‚úÖ`);
        }

        function markAllAbsent() {
            const today = new Date().toISOString().split('T')[0];
            const activeEmployees = Object.values(employeesCache).filter(emp => emp.status === 'Active');
            
            activeEmployees.forEach(emp => {
                updateAttendanceStatus(emp.username, 'Absent');
            });
            
            alert(`Marked all ${activeEmployees.length} employees as absent! ‚ùå`);
        }

        // Salary Management Functions
        function loadSalaryData() {
            // Populate month selector
            const salaryMonthElement = document.getElementById('salaryMonth');
            if (salaryMonthElement) {
                const currentMonth = new Date().toISOString().substring(0, 7);
                salaryMonthElement.innerHTML = '<option value="">Select Month</option>';
                
                // Add last 12 months
                for (let i = 0; i < 12; i++) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    const monthValue = date.toISOString().substring(0, 7);
                    const monthText = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    salaryMonthElement.innerHTML += `<option value="${monthValue}" ${monthValue === currentMonth ? 'selected' : ''}>${monthText}</option>`;
                }
            }
            
            // Generate current month report by default
            generateSalaryReport();
        }

        function generateSalaryReport() {
            const selectedMonth = document.getElementById('salaryMonth').value || new Date().toISOString().substring(0, 7);
            const activeEmployees = Object.values(employeesCache).filter(emp => emp.status === 'Active');
            
            let totalSalary = 0;
            let topEarner = { name: 'None', salary: 0 };
            
            const salaryData = activeEmployees.map(emp => {
                const salary = calculateEmployeeSalary(emp, selectedMonth);
                totalSalary += salary.calculatedSalary;
                
                if (salary.calculatedSalary > topEarner.salary) {
                    topEarner = { name: emp.name, salary: salary.calculatedSalary };
                }
                
                return salary;
            });
            
            // Update summary cards
            const totalSalaryAmountElement = document.getElementById('totalSalaryAmount');
            const totalEmployeesCountElement = document.getElementById('totalEmployeesCount');
            const avgSalaryAmountElement = document.getElementById('avgSalaryAmount');
            const topPerformerSalaryElement = document.getElementById('topPerformerSalary');
            
            if (totalSalaryAmountElement) totalSalaryAmountElement.textContent = `‚Çπ${totalSalary.toLocaleString('en-IN')}`;
            if (totalEmployeesCountElement) totalEmployeesCountElement.textContent = activeEmployees.length;
            if (avgSalaryAmountElement) avgSalaryAmountElement.textContent = `‚Çπ${Math.round(totalSalary / activeEmployees.length || 0).toLocaleString('en-IN')}`;
            if (topPerformerSalaryElement) topPerformerSalaryElement.textContent = `‚Çπ${topEarner.salary.toLocaleString('en-IN')}`;
            
            // Display salary report table
            const salaryHtml = salaryData.map(salary => `
                <tr class="border-b border-gray-100">
                    <td class="px-4 py-3 text-sm font-semibold">${salary.employeeName}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs ${getSalaryTypeColor(salary.salaryType)}">${getSalaryTypeLabel(salary.salaryType)}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">‚Çπ${salary.baseAmount.toLocaleString('en-IN')}</td>
                    <td class="px-4 py-3 text-sm">${salary.performance}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${salary.presentDays}</td>
                    <td class="px-4 py-3 text-sm font-bold text-green-600">‚Çπ${salary.calculatedSalary.toLocaleString('en-IN')}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">Calculated</span>
                    </td>
                </tr>
            `).join('');
            
            const salaryReportDataElement = document.getElementById('salaryReportData');
            if (salaryReportDataElement) {
                salaryReportDataElement.innerHTML = salaryHtml || '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No salary data available</td></tr>';
            }
            
            // Cache the report data for download
            salaryReportCache = salaryData;
        }

        function calculateEmployeeSalary(employee, month) {
            const monthSales = salesCache.filter(sale => 
                sale.username === employee.username && 
                sale.date.startsWith(month)
            );
            
            const monthAttendance = attendanceCache.filter(att => 
                att.employeeId === employee.username && 
                att.date.startsWith(month) && 
                att.status === 'Present'
            );
            
            const halfDayAttendance = attendanceCache.filter(att => 
                att.employeeId === employee.username && 
                att.date.startsWith(month) && 
                att.status === 'Half Day'
            );
            
            let calculatedSalary = 0;
            let performance = '';
            let presentDays = monthAttendance.length + (halfDayAttendance.length * 0.5);
            
            const salaryType = employee.salaryType || 'fixed';
            const baseAmount = employee.salaryAmount || 0;
            
            switch (salaryType) {
                case 'fixed':
                    calculatedSalary = baseAmount;
                    performance = 'Fixed Amount';
                    break;
                    
                case 'quantity':
                    const totalQuantity = monthSales.reduce((sum, sale) => sum + sale.quantity, 0);
                    calculatedSalary = totalQuantity * baseAmount;
                    performance = `${totalQuantity} units √ó ‚Çπ${baseAmount}`;
                    break;
                    
                case 'value':
                    const totalValue = monthSales.reduce((sum, sale) => sum + sale.total, 0);
                    calculatedSalary = (totalValue * baseAmount) / 100;
                    performance = `‚Çπ${totalValue.toLocaleString('en-IN')} √ó ${baseAmount}%`;
                    break;
                    
                case 'attendance':
                    calculatedSalary = presentDays * baseAmount;
                    performance = `${presentDays} days √ó ‚Çπ${baseAmount}`;
                    break;
                    
                default:
                    calculatedSalary = baseAmount;
                    performance = 'Default Fixed';
            }
            
            return {
                employeeId: employee.username,
                employeeName: employee.name,
                salaryType: salaryType,
                baseAmount: baseAmount,
                performance: performance,
                presentDays: presentDays,
                calculatedSalary: Math.round(calculatedSalary),
                month: month
            };
        }

        function getSalaryTypeLabel(type) {
            const labels = {
                'fixed': 'Fixed Salary',
                'quantity': 'Per Quantity',
                'value': 'Commission',
                'attendance': 'Per Day'
            };
            return labels[type] || 'Unknown';
        }

        function getSalaryTypeColor(type) {
            const colors = {
                'fixed': 'bg-blue-100 text-blue-800',
                'quantity': 'bg-green-100 text-green-800',
                'value': 'bg-purple-100 text-purple-800',
                'attendance': 'bg-orange-100 text-orange-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function downloadSalaryReport() {
            if (salaryReportCache.length === 0) {
                alert('Please generate a salary report first');
                return;
            }
            
            const selectedMonth = document.getElementById('salaryMonth').value || new Date().toISOString().substring(0, 7);
            
            // Create CSV content
            const csvContent = '\uFEFF' + [
                ['Employee ID', 'Employee Name', 'Salary Type', 'Base Amount', 'Performance', 'Present Days', 'Calculated Salary', 'Month'],
                ...salaryReportCache.map(salary => [
                    salary.employeeId,
                    `"${salary.employeeName}"`,
                    salary.salaryType,
                    salary.baseAmount,
                    `"${salary.performance}"`,
                    salary.presentDays,
                    salary.calculatedSalary,
                    salary.month
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Eden_Salary_Report_${selectedMonth}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Salary report downloaded successfully! üí∞');
        }



        // REAL-TIME: Auto-refresh data every 10 seconds for live cross-device sync
        let lastSyncTimestamp = 0;
        
        setInterval(async () => {
            if (window.db && currentUser) {
                try {
                    // Check sync timestamp first to avoid unnecessary data loading
                    const syncDocRef = window.firestore.doc(window.db, 'system', 'lastSync');
                    const syncDoc = await window.firestore.getDoc(syncDocRef);
                    
                    if (syncDoc.exists()) {
                        const syncData = syncDoc.data();
                        const serverTimestamp = syncData.timestamp || 0;
                        
                        // Only sync if there are changes from other devices
                        if (serverTimestamp > lastSyncTimestamp && syncData.lastSyncBy !== currentUser) {
                            console.log('üîÑ LIVE UPDATE detected from other device...');
                            const previousSalesCount = salesCache.length;
                            
                            // Load latest data from Firebase
                            await loadAllFirebaseData();
                            
                            // Update our timestamp
                            lastSyncTimestamp = serverTimestamp;
                            
                            // Check if new sales were added from other devices
                            const newSalesCount = salesCache.length;
                            if (newSalesCount > previousSalesCount) {
                                const newSales = newSalesCount - previousSalesCount;
                                showSyncNotification(`üî¥ LIVE: ${newSales} new sales from other devices`);
                                
                                // Refresh UI immediately
                                if (isAdmin) {
                                    await loadAdminData();
                                    if (document.getElementById('allSalesData')) {
                                        loadAllSalesData();
                                    }
                                } else {
                                    loadEmployeeSalesData();
                                }
                                
                                // Play notification sound (if supported)
                                try {
                                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                                    audio.volume = 0.1;
                                    audio.play().catch(() => {}); // Ignore errors
                                } catch (e) {}
                            } else if (syncData.salesCount !== salesCache.length || syncData.employeesCount !== Object.keys(employeesCache).length) {
                                // Data structure changed
                                showSyncNotification('üîÑ LIVE: Data updated from other devices');
                                
                                // Refresh UI
                                if (isAdmin) {
                                    await loadAdminData();
                                } else {
                                    loadEmployeeSalesData();
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in real-time sync:', error);
                }
            }
        }, 10000); // Check every 10 seconds for real-time updates

        // INSTANT: Sync check when app becomes visible (user switches back to tab)
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && window.db && currentUser) {
                console.log('üîÑ App became visible - INSTANT sync check...');
                try {
                    // Force immediate sync check
                    const syncDocRef = window.firestore.doc(window.db, 'system', 'lastSync');
                    const syncDoc = await window.firestore.getDoc(syncDocRef);
                    
                    if (syncDoc.exists()) {
                        const syncData = syncDoc.data();
                        const serverTimestamp = syncData.timestamp || 0;
                        
                        // Always sync when coming back to tab
                        if (serverTimestamp > lastSyncTimestamp) {
                            const previousSalesCount = salesCache.length;
                            await loadAllFirebaseData();
                            lastSyncTimestamp = serverTimestamp;
                            
                            const newSalesCount = salesCache.length;
                            if (newSalesCount > previousSalesCount) {
                                const newSales = newSalesCount - previousSalesCount;
                                showSyncNotification(`‚ö° INSTANT: ${newSales} new sales synced while away`);
                                
                                // Refresh current view immediately
                                if (isAdmin) {
                                    await loadAdminData();
                                    if (document.getElementById('allSalesData')) {
                                        loadAllSalesData();
                                    }
                                } else {
                                    loadEmployeeSalesData();
                                }
                            } else {
                                showSyncNotification('‚ö° INSTANT: Data synced and up to date');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in instant visibility sync:', error);
                }
            }
        });

        // INSTANT Manual sync function for the sync button
        async function manualSync() {
            const syncButtons = document.querySelectorAll('button[onclick="manualSync()"]');
            syncButtons.forEach(btn => {
                btn.innerHTML = '‚è≥';
                btn.disabled = true;
            });

            try {
                // Enhanced Firebase connection check
                if (!window.db || !window.firestore) {
                    console.log('üì± Firebase not initialized - refreshing local data only');
                    showSyncNotification('üì± Local mode - Firebase not connected');
                    
                    // Still refresh local data
                    if (currentUser) {
                        if (isAdmin) {
                            await loadAdminData();
                            loadStaffData();
                            loadProductsData();
                            loadStoresData();
                        } else {
                            loadEmployeeSalesData();
                        }
                    }
                    return;
                }

                // Test Firebase connection first
                try {
                    const testRef = window.firestore.doc(window.db, 'system', 'connection_test');
                    await window.firestore.getDoc(testRef);
                    console.log('üî• Firebase connection verified for manual sync');
                } catch (connectionError) {
                    console.warn('‚ùå Firebase connection failed during manual sync:', connectionError);
                    
                    let errorMessage = '‚ùå Sync failed - ';
                    if (connectionError.code === 'permission-denied') {
                        errorMessage += 'Firebase permissions needed';
                    } else if (connectionError.code === 'unavailable') {
                        errorMessage += 'Firebase offline';
                    } else if (connectionError.message.includes('network')) {
                        errorMessage += 'network error';
                    } else {
                        errorMessage += 'connection error';
                    }
                    
                    showSyncNotification(errorMessage);
                    
                    // Still refresh local data
                    if (currentUser) {
                        if (isAdmin) {
                            await loadAdminData();
                            loadStaffData();
                            loadProductsData();
                            loadStoresData();
                        } else {
                            loadEmployeeSalesData();
                        }
                    }
                    return;
                }

                console.log('üîÑ Manual sync initiated with Firebase...');
                
                // Force immediate sync check
                const syncDocRef = window.firestore.doc(window.db, 'system', 'lastSync');
                const syncDoc = await window.firestore.getDoc(syncDocRef);
                
                const previousSalesCount = salesCache.length;
                const previousEmployeesCount = Object.keys(employeesCache).length;
                
                // Always reload data on manual sync
                await loadAllFirebaseData();
                
                // Update timestamp
                if (syncDoc.exists()) {
                    const syncData = syncDoc.data();
                    lastSyncTimestamp = syncData.timestamp || Date.now();
                }
                
                const newSalesCount = salesCache.length;
                const newEmployeesCount = Object.keys(employeesCache).length;
                
                let syncMessage = '‚úÖ Manual sync completed';
                
                if (newSalesCount > previousSalesCount) {
                    const newSales = newSalesCount - previousSalesCount;
                    syncMessage = `‚úÖ ${newSales} new sales synced from Firebase`;
                } else if (newEmployeesCount > previousEmployeesCount) {
                    const newEmployees = newEmployeesCount - previousEmployeesCount;
                    syncMessage = `‚úÖ ${newEmployees} new employees synced from Firebase`;
                } else if (newSalesCount < previousSalesCount) {
                    const deletedSales = previousSalesCount - newSalesCount;
                    syncMessage = `‚úÖ ${deletedSales} sales updated from Firebase`;
                } else {
                    syncMessage = '‚úÖ All data is up to date with Firebase';
                }
                
                showSyncNotification(syncMessage);
                
                // Force refresh current view
                if (currentUser) {
                    if (isAdmin) {
                        await loadAdminData();
                        if (document.getElementById('allSalesData')) {
                            loadAllSalesData();
                        }
                        // Refresh all admin tabs
                        loadStaffData();
                        loadProductsData();
                        loadStoresData();
                    } else {
                        loadEmployeeSalesData();
                    }
                }
                
                // Show detailed sync info in console
                console.log(`üìä Sync Results:
                    Sales: ${previousSalesCount} ‚Üí ${newSalesCount}
                    Employees: ${previousEmployeesCount} ‚Üí ${newEmployeesCount}
                    Products: ${productsCache.length}
                    Stores: ${storesCache.length}`);
                
            } catch (error) {
                console.error('Manual sync error:', error);
                
                // Better error messages
                let errorMessage = '‚ùå Sync failed - ';
                if (error.code === 'permission-denied') {
                    errorMessage += 'Firebase permissions needed';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'Firebase offline';
                } else if (error.message.includes('network')) {
                    errorMessage += 'network error';
                } else {
                    errorMessage += 'connection error';
                }
                
                showSyncNotification(errorMessage);
                
                // Still try to refresh local data
                try {
                    if (currentUser) {
                        if (isAdmin) {
                            await loadAdminData();
                            loadStaffData();
                            loadProductsData();
                            loadStoresData();
                        } else {
                            loadEmployeeSalesData();
                        }
                    }
                } catch (localError) {
                    console.error('Local data refresh also failed:', localError);
                }
                
            } finally {
                // Reset sync buttons
                syncButtons.forEach(btn => {
                    btn.innerHTML = 'üîÑ';
                    btn.disabled = false;
                });
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968b6a50f11df9f0',t:'MTc1NDExNTA2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
